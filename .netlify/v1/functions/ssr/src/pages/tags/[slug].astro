---
import BaseLayout from "../../layouts/BaseLayout.astro";
import GameCard from "../../components/GameCard.astro";
import { supabase } from "../../lib/supabase";

export async function getStaticPaths() {
  const { data: games } = await supabase.from("games").select("tags");

  if (!games) return [];

  const tags = Array.from(new Set(
    games.flatMap((game) => game.tags || [])
  ));

  return tags.map((tag) => ({
    params: { slug: tag.toLowerCase().replace(/\s+/g, "-") },
  }));
}

const { slug } = Astro.params;
const humanReadableTag = slug.replace(/-/g, " ");
const { data: games } = await supabase
  .from("games")
  .select("*");

const filteredGames = (games || []).filter((game) =>
  game.tags?.some((tag) => tag.toLowerCase().replace(/\s+/g, "-") === slug)
);
---

<BaseLayout title={`Games Tagged "${humanReadableTag}"`}>
  <section class="py-12">
    <div class="max-w-7xl mx-auto px-4">
      <nav class="text-sm text-gray-500 mb-6">
        <a href="/" class="hover:underline">Home</a> › <a href="/tags" class="hover:underline">Tags</a> › <span class="font-bold">{humanReadableTag}</span>
      </nav>

      <h1 class="text-3xl font-bold mb-8">Games Tagged: {humanReadableTag}</h1>

      {filteredGames.length > 0 ? (
        <div class="grid md:grid-cols-3 gap-8">
          {filteredGames.map((game) => (
            <GameCard game={game} size="small" />
          ))}
        </div>
      ) : (
        <p class="text-center text-gray-600">No games found with this tag.</p>
      )}

      <div class="mt-12 text-center">
        <a href="/games" class="inline-block bg-red-600 text-white px-6 py-3 rounded-lg hover:bg-red-700 transition">
          ← Back to All Games
        </a>
      </div>
    </div>
  </section>
</BaseLayout>
