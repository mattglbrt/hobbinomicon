---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import PageHeader from '../../components/PageHeader.astro';
import Footer from '../../components/Footer.astro';

const allProjects = await getCollection('projects');
const allPosts = await getCollection('blog');

// Filter out draft projects
const publishedProjects = allProjects.filter(project => !project.data.draft);

// For each project, get the latest post's hero image and post count
const projectsWithMeta = publishedProjects.map(project => {
  const projectPosts = allPosts
    .filter(post => post.data.project === project.data.slug && !post.data.draft)
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

  const latestPost = projectPosts[0];

  return {
    ...project,
    postCount: projectPosts.length,
    heroImage: latestPost?.data.heroImage,
    heroImageAlt: latestPost?.data.heroImageAlt || project.data.title,
  };
}).sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());
---

<BaseLayout title="Projects - The Hobbinomicon">
  <Header theme="light" />

  <div class="min-h-screen bg-parchment">
    <PageHeader
      title="Projects"
      description="Long-form series and ongoing creative endeavors"
      backLink={{ href: "/", text: "Back to Home" }}
    />

    <div class="max-w-7xl mx-auto px-6 py-16">
      {projectsWithMeta.length === 0 ? (
        <p class="text-center text-ink/60 text-lg">No projects yet. Check back soon!</p>
      ) : (
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {projectsWithMeta.map((project) => (
            <a
              href={`/projects/${project.data.slug}`}
              class="group block bg-white rounded-lg overflow-hidden shadow-md hover:shadow-xl transition-all duration-300 border-2 border-ink/10 hover:border-ink/20"
            >
              {project.heroImage ? (
                <div class="aspect-video overflow-hidden">
                  <img
                    src={project.heroImage}
                    alt={project.heroImageAlt}
                    class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                    loading="lazy"
                    decoding="async"
                  />
                </div>
              ) : (
                <div class="aspect-video bg-ink/10 flex items-center justify-center">
                  <span class="text-ink/40 text-4xl">üìÅ</span>
                </div>
              )}
              <div class="p-6">
                <h2 class="text-xl font-heading font-bold text-ink group-hover:text-ink/80 transition-colors">
                  {project.data.title}
                </h2>
                <p class="text-ink/70 mt-2 line-clamp-2">{project.data.description}</p>
                <div class="mt-4 flex items-center text-sm text-ink/50">
                  <span>{project.postCount} {project.postCount === 1 ? 'post' : 'posts'}</span>
                </div>
              </div>
            </a>
          ))}
        </div>
      )}
    </div>

    <Footer />
  </div>
</BaseLayout>
