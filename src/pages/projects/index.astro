---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import PageHeader from '../../components/PageHeader.astro';
import Footer from '../../components/Footer.astro';
import StructuredData from '../../components/StructuredData.astro';
import ContentContainer from '../../components/ContentContainer.astro';
import ImageCard from '../../components/ImageCard.astro';
import { getHeroImage } from '../../utils/getHeroImage';

const allProjects = await getCollection('projects');
const allPosts = await getCollection('blog');

// Filter out draft projects
const publishedProjects = allProjects.filter(project => !project.data.draft);

// For each project, get the latest post's hero image and post count
const projectsWithMeta = publishedProjects.map(project => {
  // Strip file extension from project.id for matching
  const projectSlug = project.id.replace(/\.[^/.]+$/, '');
  const projectPosts = allPosts
    .filter(post => post.data.project === projectSlug && !post.data.draft)
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

  const latestPost = projectPosts[0];

  return {
    ...project,
    projectSlug,
    postCount: projectPosts.length,
    heroImage: latestPost ? getHeroImage(latestPost.data.heroImage, latestPost.data.youtubeId) : null,
    heroImageAlt: latestPost?.data.heroImageAlt || project.data.title,
    latestPostDate: latestPost?.data.pubDate,
  };
}).sort((a, b) => {
  // Sort by latest post date (projects with most recent activity first)
  const dateA = a.latestPostDate?.valueOf() || 0;
  const dateB = b.latestPostDate?.valueOf() || 0;
  return dateB - dateA;
});
---

<BaseLayout title="Projects - The Hobbinomicon">
  <StructuredData
    type="breadcrumb"
    data={{
      breadcrumbs: [
        { name: 'Home', url: 'https://hobbinomicon.com/' },
        { name: 'Projects', url: 'https://hobbinomicon.com/projects' },
      ],
    }}
  />
  <Header theme="light" />

  <main id="main-content" class="min-h-screen bg-parchment dark:bg-parchment-dark">
    <PageHeader
      title="Projects"
      description="Long-form series and ongoing creative endeavors"
      backLink={{ href: "/", text: "Back to Home" }}
    />

    <ContentContainer class="py-16">
      {projectsWithMeta.length === 0 ? (
        <p class="text-center text-ink/70 dark:text-ink-dark/70 text-lg">No projects yet. Check back soon!</p>
      ) : (
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {projectsWithMeta.map((project) => (
            <ImageCard
              href={`/projects/${project.projectSlug}`}
              image={project.heroImage}
              imageAlt={project.heroImageAlt}
              title={project.data.title}
              fallbackIcon="ðŸ“"
              aspectRatio="video"
              variant="stacked"
            >
              <h2 class="text-xl font-heading font-bold text-ink dark:text-ink-dark group-hover:text-ink/80 dark:group-hover:text-ink-dark/80 transition-colors">
                {project.data.title}
              </h2>
              <p class="text-ink/70 dark:text-ink-dark/70 mt-2 line-clamp-2">{project.data.description}</p>
              <div class="mt-4 flex items-center text-sm text-ink/50 dark:text-ink-dark/50">
                <span>{project.postCount} {project.postCount === 1 ? 'post' : 'posts'}</span>
              </div>
            </ImageCard>
          ))}
        </div>
      )}
    </ContentContainer>

    <Footer />
  </main>
</BaseLayout>
