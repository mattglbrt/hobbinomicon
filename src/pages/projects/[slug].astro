---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import PostCard from '../../components/PostCard.astro';
import BackToTop from '../../components/BackToTop.astro';
import StructuredData from '../../components/StructuredData.astro';
import ContentContainer from '../../components/ContentContainer.astro';
import { getPublishedPosts, sortByDate } from '../../utils/collections';
import { getHeroImage } from '../../utils/getHeroImage';
import ProseContent from '../../components/ProseContent.astro';

export async function getStaticPaths() {
  const allProjects = await getCollection('projects');
  const allPosts = await getCollection('blog');
  const publishedPosts = getPublishedPosts(allPosts);

  return allProjects
    .filter(project => !project.data.draft)
    .map(project => {
      // Strip file extension from project.id for matching
      const projectSlug = project.id.replace(/\.[^/.]+$/, '');
      const projectPosts = publishedPosts
        .filter(post => post.data.project === projectSlug)
        .sort((a, b) => {
          // Sort by projectOrder if available, otherwise by pubDate
          if (a.data.projectOrder !== undefined && b.data.projectOrder !== undefined) {
            return a.data.projectOrder - b.data.projectOrder;
          }
          return a.data.pubDate.valueOf() - b.data.pubDate.valueOf();
        });

      return {
        params: { slug: projectSlug },
        props: { project, posts: projectPosts },
      };
    });
}

const { project, posts } = Astro.props;
const { Content } = await project.render();

// Get project slug from params
const projectSlug = Astro.params.slug;

// Get the latest post's hero image for the header
const latestPost = sortByDate(posts)[0];
const heroImage = latestPost ? getHeroImage(latestPost.data.heroImage, latestPost.data.youtubeId) : null;
const heroImageAlt = latestPost?.data.heroImageAlt || project.data.title;
---

<BaseLayout title={`${project.data.title} - The Hobbinomicon`} description={project.data.description}>
  <StructuredData
    type="breadcrumb"
    data={{
      breadcrumbs: [
        { name: 'Home', url: 'https://hobbinomicon.com/' },
        { name: 'Projects', url: 'https://hobbinomicon.com/projects' },
        { name: project.data.title, url: `https://hobbinomicon.com/projects/${projectSlug}` },
      ],
    }}
  />
  <Header />
  <main id="main-content" class="min-h-screen bg-parchment dark:bg-parchment-dark">
    <!-- Hero Image -->
    <div class="relative h-[50vh] md:h-[60vh] overflow-hidden">
      {heroImage ? (
        <img
          src={heroImage}
          alt={heroImageAlt}
          class="w-full h-full object-cover"
          width="1920"
          height="1080"
        />
      ) : (
        <div class="w-full h-full bg-ink/20"></div>
      )}
      <div class="absolute inset-0 bg-gradient-to-t from-ink/70 to-transparent"></div>

      <!-- Title Overlay -->
      <div class="absolute bottom-0 left-0 right-0 p-8 md:p-12 lg:p-16">
        <div class="max-w-4xl">
          <a href="/projects" class="inline-block text-white/80 hover:text-white mb-4 transition-colors text-sm">
            ‚Üê Back to Projects
          </a>
          <h1 class="text-4xl md:text-5xl lg:text-6xl font-heading font-bold text-white mb-4 drop-shadow-2xl">
            {project.data.title}
          </h1>
          <p class="text-white/90 text-lg md:text-xl max-w-2xl">
            {project.data.description}
          </p>
          <div class="mt-4 text-white/70 text-sm">
            {posts.length} {posts.length === 1 ? 'post' : 'posts'} in this project
          </div>
        </div>
      </div>
    </div>

    <!-- Project Introduction Content -->
    <ContentContainer maxWidth="3xl" class="py-12 md:py-16">
      <ProseContent>
        <Content />
      </ProseContent>
    </ContentContainer>

    <!-- Posts Section -->
    <div class="bg-ink/5 border-t-2 border-ink/10">
      <ContentContainer class="py-16">
        <h2 class="text-3xl font-heading font-bold text-ink mb-8">
          Posts in this Project
        </h2>

        {posts.length === 0 ? (
          <p class="text-ink/70 text-lg">No posts in this project yet. Check back soon!</p>
        ) : (
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {posts.map((post, index) => (
              <div class="relative">
                {post.data.projectOrder !== undefined && (
                  <div class="absolute -top-3 -left-3 w-8 h-8 bg-ink text-parchment rounded-full flex items-center justify-center text-sm font-bold z-10">
                    {post.data.projectOrder}
                  </div>
                )}
                <PostCard post={post} />
              </div>
            ))}
          </div>
        )}
      </ContentContainer>
    </div>

    <BackToTop />
  </main>
  <Footer />
</BaseLayout>
