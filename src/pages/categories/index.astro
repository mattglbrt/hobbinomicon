---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import PageHeader from '../../components/PageHeader.astro';
import Footer from '../../components/Footer.astro';
import StructuredData from '../../components/StructuredData.astro';
import ContentContainer from '../../components/ContentContainer.astro';
import ImageCard from '../../components/ImageCard.astro';
import { getCategoriesWithCounts } from '../../utils/collections';
import { getHeroImage } from '../../utils/getHeroImage';

const allPosts = await getCollection('blog');

// Get categories with counts, sorted by post count
const categories = getCategoriesWithCounts(allPosts).map(({ name, count, posts }) => {
  // Find the most recent post with a hero image or YouTube video
  const postWithImage = posts.find(post => post.data.heroImage || post.data.youtubeId) || posts[0];
  const categoryImage = postWithImage ? getHeroImage(postWithImage.data.heroImage, postWithImage.data.youtubeId) : null;
  return { name, count, latestPost: postWithImage, categoryImage };
});
---

<BaseLayout title="Categories - The Hobbinomicon">
  <StructuredData
    type="breadcrumb"
    data={{
      breadcrumbs: [
        { name: 'Home', url: 'https://hobbinomicon.com/' },
        { name: 'Categories', url: 'https://hobbinomicon.com/categories' },
      ],
    }}
  />
  <Header theme="light" />

  <main id="main-content" class="min-h-screen bg-parchment dark:bg-parchment-dark">
    <PageHeader
      title="Categories"
      description="Explore posts by topic"
      breadcrumbs={[
        { label: "Categories", href: "/categories" }
      ]}
    />

    <ContentContainer class="py-16">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        {categories.map(({ name, count, latestPost, categoryImage }) => (
          <ImageCard
            href={`/categories/${name.toLowerCase().replace(/\s+/g, '-')}`}
            image={categoryImage}
            imageAlt={latestPost.data.heroImageAlt || name}
            title={name}
            subtitle={`${count} ${count === 1 ? 'post' : 'posts'}`}
            fallbackLetter={name.charAt(0)}
            aspectRatio="16/9"
            variant="overlay"
          />
        ))}
      </div>
    </ContentContainer>

    <Footer />
  </main>
</BaseLayout>
