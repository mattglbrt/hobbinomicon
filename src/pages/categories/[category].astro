---
import { getCollection } from 'astro:content';
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import PageHeader from '../../components/PageHeader.astro';
import PostCard from '../../components/PostCard.astro';
import Footer from '../../components/Footer.astro';
import StructuredData from '../../components/StructuredData.astro';
import ContentContainer from '../../components/ContentContainer.astro';
import { getPublishedPosts, groupByCategory, sortByDate } from '../../utils/collections';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog');
  const publishedPosts = getPublishedPosts(allPosts);
  const categoriesMap = groupByCategory(publishedPosts);

  return Array.from(categoriesMap.entries()).map(([category, posts]) => ({
    params: { category: category.toLowerCase().replace(/\s+/g, '-') },
    props: { category, posts: sortByDate(posts) },
  }));
}

const { category, posts } = Astro.props;
---

<BaseLayout title={`${category} - The Hobbinomicon`}>
  <StructuredData
    type="breadcrumb"
    data={{
      breadcrumbs: [
        { name: 'Home', url: 'https://hobbinomicon.com/' },
        { name: 'Categories', url: 'https://hobbinomicon.com/categories' },
        { name: category, url: `https://hobbinomicon.com/categories/${category.toLowerCase().replace(/\s+/g, '-')}` },
      ],
    }}
  />
  <Header theme="light" />

  <main id="main-content" class="min-h-screen bg-parchment dark:bg-parchment-dark">
    <PageHeader
      title={category}
      description={`${posts.length} ${posts.length === 1 ? 'post' : 'posts'}`}
      breadcrumbs={[
        { label: "Categories", href: "/categories" },
        { label: category, href: `/categories/${category.toLowerCase().replace(/\s+/g, '-')}` }
      ]}
    />

    <ContentContainer class="py-16">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        {posts.map((post) => (
          <PostCard post={post} showCategory={false} />
        ))}
      </div>
    </ContentContainer>

    <Footer />
  </main>
</BaseLayout>
