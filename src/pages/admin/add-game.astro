---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { supabase } from "../../lib/supabase";
import "../../styles/global.css";
---

<BaseLayout title="Add New Game">
  <main class="max-w-2xl mx-auto px-4 py-10">
    <h1 class="text-3xl font-bold mb-6 text-center">Add New Game</h1>

    <div id="status-message" class="text-center text-sm mb-6"></div>

    <form id="add-game-form" class="space-y-6">
      <input 
        name="title" 
        type="text" 
        placeholder="Title" 
        required 
        class="w-full border rounded px-3 py-2" 
      />

      <textarea
        name="description"
        placeholder="Description"
        required
        class="w-full border rounded px-3 py-2"
      ></textarea>

      <input
        name="publication_year"
        type="number"
        placeholder="Publication Year"
        class="w-full border rounded px-3 py-2"
      />

      <div class="flex gap-4">
        <input
          name="min_players"
          type="number"
          placeholder="Min Players"
          class="flex-1 border rounded px-3 py-2"
        />
        <input
          name="max_players"
          type="number"
          placeholder="Max Players"
          class="flex-1 border rounded px-3 py-2"
        />
      </div>

      <input
        name="play_time"
        type="text"
        placeholder="Play Time (e.g., 60-90 mins)"
        class="w-full border rounded px-3 py-2"
      />

      <input
        name="age_range"
        type="text"
        placeholder="Age Range (e.g., 14+)"
        class="w-full border rounded px-3 py-2"
      />

      <input
        name="official_website"
        type="url"
        placeholder="Official Website"
        class="w-full border rounded px-3 py-2"
      />

      <input
        name="rules_url"
        type="url"
        placeholder="Rules URL"
        class="w-full border rounded px-3 py-2"
      />

      <input
        name="tags"
        type="text"
        placeholder="Comma separated tags (e.g., Wargame, Fantasy)"
        class="w-full border rounded px-3 py-2"
      />

      <button type="submit" class="w-full bg-primary text-white font-bold py-2 px-4 rounded hover:bg-primary-dark">
        Add Game
      </button>
    </form>
  </main>

  <script type="module">
    import { supabase } from "../../lib/supabase";

    const form = document.getElementById('add-game-form');
    const statusMessage = document.getElementById('status-message');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(form);

      const newGame = {
        title: formData.get('title'),
        description: formData.get('description'),
        publication_year: formData.get('publication_year') ? parseInt(formData.get('publication_year')) : null,
        min_players: formData.get('min_players') ? parseInt(formData.get('min_players')) : null,
        max_players: formData.get('max_players') ? parseInt(formData.get('max_players')) : null,
        play_time: formData.get('play_time'),
        age_range: formData.get('age_range'),
        official_website: formData.get('official_website'),
        rules_url: formData.get('rules_url'),
        tags: formData.get('tags') ? formData.get('tags').split(',').map(tag => tag.trim()) : [],
      };

      const { error } = await supabase
        .from('games')
        .insert([newGame]);

      if (error) {
        console.error('Error adding game:', error.message);
        statusMessage.textContent = "❌ Error adding game!";
        statusMessage.classList.add('text-red-600');
        statusMessage.classList.remove('text-green-600');
      } else {
        statusMessage.textContent = "✅ Game added successfully!";
        statusMessage.classList.add('text-green-600');
        statusMessage.classList.remove('text-red-600');
        form.reset();
      }
    });
  </script>
</BaseLayout>
