---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { supabase } from "../../lib/supabase";

let status = "";

async function handleSubmit(event) {
  event.preventDefault();
  const formData = new FormData(event.target);
  
  const game = {
    title: formData.get("title"),
    slug: formData.get("slug") || formData.get("title").toLowerCase().replace(/\s+/g, "-"),
    description: formData.get("description"),
    publication_year: formData.get("publication_year"),
    min_players: parseInt(formData.get("min_players")),
    max_players: parseInt(formData.get("max_players")),
    play_time: formData.get("play_time"),
    age_range: formData.get("age_range"),
    official_website: formData.get("official_website"),
    rules_url: formData.get("rules_url"),
    tags: formData.get("tags").split(",").map(tag => tag.trim()).filter(tag => tag),
  };

  const { data, error } = await supabase.from("games").insert([game]);
  if (error) {
    status = "error";
    console.error(error);
  } else {
    await saveTags(game.tags);
    status = "success";
  }
}

async function saveTags(tagsArray) {
  if (!tagsArray || tagsArray.length === 0) return;

  for (const tag of tagsArray) {
    const slug = tag.toLowerCase().replace(/\s+/g, "-");
    await supabase.from("tags").upsert([{ name: tag, slug }], { onConflict: "slug" });
  }
}
---

<BaseLayout>
  <section class="max-w-3xl mx-auto py-12">
    <h1 class="text-3xl font-bold mb-6">Add New Game</h1>
    <form on:submit={handleSubmit} class="space-y-6">
      <input type="text" name="title" placeholder="Game Title" required class="input" />
      <input type="text" name="slug" placeholder="Slug (optional)" class="input" />
      <textarea name="description" placeholder="Description" required class="input"></textarea>
      <input type="number" name="publication_year" placeholder="Publication Year" class="input" />
      <input type="number" name="min_players" placeholder="Min Players" class="input" />
      <input type="number" name="max_players" placeholder="Max Players" class="input" />
      <input type="text" name="play_time" placeholder="Play Time" class="input" />
      <input type="text" name="age_range" placeholder="Age Range" class="input" />
      <input type="url" name="official_website" placeholder="Official Website" class="input" />
      <input type="url" name="rules_url" placeholder="Rules URL" class="input" />
      <input type="text" name="tags" placeholder="Tags (comma separated)" class="input" />

      <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded">Save Game</button>

      {status === "success" && <p class="text-green-600 mt-4">Game saved successfully!</p>}
      {status === "error" && <p class="text-red-600 mt-4">Error saving game.</p>}
    </form>
  </section>
</BaseLayout>
