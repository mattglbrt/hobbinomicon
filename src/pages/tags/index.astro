---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { supabase } from "../../lib/supabase";

const { data: games, error } = await supabase.from("games").select("tags");

if (error) {
  console.error("Failed to fetch games for tags:", error);
}

const tagCounts = {};

if (games) {
  games.forEach((game) => {
    (game.tags || []).forEach((tag) => {
      const slug = tag.toLowerCase().replace(/\s+/g, "-");
      if (!tagCounts[slug]) {
        tagCounts[slug] = { label: tag, count: 1 };
      } else {
        tagCounts[slug].count++;
      }
    });
  });
}

const tags = Object.entries(tagCounts).map(([slug, { label, count }]) => ({
  slug,
  label,
  count,
}));
---

<BaseLayout title="Browse by Tags">
  <section class="py-12">
    <div class="max-w-7xl mx-auto px-4">
      <nav class="text-sm text-gray-500 mb-6">
        <a href="/" class="hover:underline">Home</a> â€º <span class="font-bold">Tags</span>
      </nav>

      <h1 class="text-3xl font-bold mb-8">Browse by Tags</h1>

      {tags.length > 0 ? (
        <div class="grid md:grid-cols-3 gap-6">
          {tags.map((tag) => (
            <a href={`/tags/${tag.slug}`} class="block rounded-xl shadow-md bg-white hover:shadow-lg transition p-6">
              <div class="flex justify-between items-center">
                <span class="font-semibold text-lg">{tag.label}</span>
                <span class="bg-gray-200 text-gray-700 text-xs rounded-full px-3 py-1">{tag.count}</span>
              </div>
            </a>
          ))}
        </div>
      ) : (
        <p class="text-center text-gray-600">No tags found.</p>
      )}
    </div>
  </section>
</BaseLayout>
