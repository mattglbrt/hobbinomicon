---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import HeroSection from '../components/HeroSection.astro';
import PostGridSection from '../components/PostGridSection.astro';
import FeaturedProjectSection from '../components/FeaturedProjectSection.astro';
import CharacterSlider from '../components/CharacterSlider.astro';
import YouTubeCTA from '../components/YouTubeCTA.astro';
import Footer from '../components/Footer.astro';
import { getHeroImage } from '../utils/getHeroImage';
import { filterDrafts } from '../utils/filterDrafts';

// Get all blog posts and sort by date
const allPosts = await getCollection('blog');
const publishedPosts = filterDrafts(allPosts);
const sortedPosts = publishedPosts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Get the most recent featured post for hero, or fall back to latest post
const featuredPosts = sortedPosts.filter(post => post.data.featured);
const latestPost = featuredPosts[0] || sortedPosts[0];

// Get 6 most recent resource posts
const resourcePosts = sortedPosts
  .filter(post => post.data.category === 'Resources')
  .slice(0, 6);

// Get all projects and their latest posts
const allProjects = await getCollection('projects');
const publishedProjects = allProjects.filter(project => !project.data.draft);

// For each project, get the latest post
const projectsWithLatestPost = publishedProjects.map(project => {
  const projectSlug = project.id.replace(/\.[^/.]+$/, '');
  const projectPosts = sortedPosts
    .filter(post => post.data.project === projectSlug)
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

  const latestProjectPost = projectPosts[0];

  return {
    project,
    projectSlug,
    latestPost: latestProjectPost,
    latestPostDate: latestProjectPost?.data.pubDate,
  };
}).filter(p => p.latestPost)
  .sort((a, b) => {
    const dateA = a.latestPostDate?.valueOf() || 0;
    const dateB = b.latestPostDate?.valueOf() || 0;
    return dateB - dateA;
  })
  .slice(0, 5);

// Get recent posts excluding hero, resources, featured project posts, and character posts
const excludedSlugs = new Set([
  latestPost.slug,
  ...resourcePosts.map(p => p.slug),
  ...projectsWithLatestPost.map(p => p.latestPost.slug)
]);
const recentPosts = sortedPosts
  .filter(post => !excludedSlugs.has(post.slug) && post.data.category !== 'Dramatis Personae')
  .slice(0, 6);

// Get character posts sorted by most recently updated
const characterPosts = publishedPosts
  .filter(post => post.data.category === 'Dramatis Personae')
  .sort((a, b) => {
    const dateA = (a.data.updatedDate || a.data.pubDate).valueOf();
    const dateB = (b.data.updatedDate || b.data.pubDate).valueOf();
    return dateB - dateA;
  })
  .slice(0, 9);

// Get the most recent project with its posts for the featured section
const featuredProject = projectsWithLatestPost[0];
const featuredProjectPosts = featuredProject ? sortedPosts
  .filter(post => post.data.project === featuredProject.projectSlug)
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
  .slice(0, 4) : [];
---

<BaseLayout title="The Hobbinomicon">
  <Header theme="dark" />

  <main id="main-content" class="min-h-screen">
    <!-- Latest Post - Full Screen Hero -->
    {latestPost && (
      <HeroSection
        slug={latestPost.slug}
        title={latestPost.data.title}
        description={latestPost.data.description}
        heroImage={getHeroImage(latestPost.data.heroImage, latestPost.data.youtubeId)}
        heroImageAlt={latestPost.data.heroImageAlt}
        category={latestPost.data.category}
        pubDate={latestPost.data.pubDate}
        tags={latestPost.data.tags}
        badge="Latest Post"
        size="large"
      />
    )}

    <!-- Resource Posts Section -->
    <PostGridSection
      title="Resources"
      viewAllLink="/categories/resources"
      posts={resourcePosts}
    />

    <!-- Featured Project Section -->
    {featuredProject && featuredProjectPosts.length > 0 && (
      <FeaturedProjectSection
        projectSlug={featuredProject.projectSlug}
        project={featuredProject.project}
        posts={featuredProjectPosts}
      />
    )}

    <!-- Recent Posts Section -->
    <PostGridSection
      title="More Posts"
      viewAllLink="/blog"
      posts={recentPosts}
    />

    <!-- Characters Section -->
    <CharacterSlider characters={characterPosts} />

    <!-- YouTube CTA Section -->
    <YouTubeCTA />

    <Footer />
  </main>
</BaseLayout>
