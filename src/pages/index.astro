---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import HeroSection from '../components/HeroSection.astro';
import PostGridSection from '../components/PostGridSection.astro';
import FeaturedProjectSection from '../components/FeaturedProjectSection.astro';
import CharacterSlider from '../components/CharacterSlider.astro';
import YouTubeCTA from '../components/YouTubeCTA.astro';
import Footer from '../components/Footer.astro';
import { getHeroImage, getHeroImageUrl } from '../utils/getHeroImage';
import { getPublishedPosts, sortByDate } from '../utils/collections';

// Get all blog posts and sort by date
const allPosts = await getCollection('blog');
const publishedPosts = getPublishedPosts(allPosts);
const sortedPosts = publishedPosts;

// Get the most recent featured post for hero, or fall back to latest post
const featuredPosts = sortedPosts.filter(post => post.data.featured);
const latestPost = featuredPosts[0] || sortedPosts[0];

// Define pinned resource slugs (in order of priority)
const pinnedResourceSlugs = [
  'resources/trench-crusade-resources',
  'resources/warmachine-resources'
];

// Get all resource posts
const allResourcePosts = sortedPosts.filter(post => post.data.category === 'Resources');

// Separate pinned posts from the rest
const pinnedPosts = pinnedResourceSlugs
  .map(slug => allResourcePosts.find(post => post.slug === slug))
  .filter(Boolean);

const unpinnedResourcePosts = allResourcePosts
  .filter(post => !pinnedResourceSlugs.includes(post.slug));

// Combine: pinned first, then most recent unpinned posts
const resourcePosts = [...pinnedPosts, ...unpinnedResourcePosts].slice(0, 6);

// Get all projects and their latest posts
const allProjects = await getCollection('projects');
const publishedProjects = allProjects.filter(project => !project.data.draft);

// For each project, get the latest post
const projectsWithLatestPost = publishedProjects.map(project => {
  const projectSlug = project.id.replace(/\.[^/.]+$/, '');
  const projectPosts = sortByDate(sortedPosts.filter(post => post.data.project === projectSlug));
  const latestProjectPost = projectPosts[0];

  return {
    project,
    projectSlug,
    latestPost: latestProjectPost,
    latestPostDate: latestProjectPost?.data.pubDate,
  };
}).filter(p => p.latestPost)
  .sort((a, b) => {
    const dateA = a.latestPostDate?.valueOf() || 0;
    const dateB = b.latestPostDate?.valueOf() || 0;
    return dateB - dateA;
  })
  .slice(0, 5);

// Get recent posts excluding hero, resources, and featured project posts
const excludedSlugs = new Set([
  latestPost.slug,
  ...resourcePosts.map(p => p.slug),
  ...projectsWithLatestPost.map(p => p.latestPost.slug)
]);

// Get recent vlog posts (posts with YouTube videos)
const recentVlogs = sortedPosts
  .filter(post => !excludedSlugs.has(post.slug) && post.data.youtubeId)
  .slice(0, 6);

// Get character posts sorted by most recently updated
const characterPosts = publishedPosts
  .filter(post => post.data.category === 'Dramatis Personae')
  .sort((a, b) => {
    const dateA = (a.data.updatedDate || a.data.pubDate).valueOf();
    const dateB = (b.data.updatedDate || b.data.pubDate).valueOf();
    return dateB - dateA;
  })
  .slice(0, 9);

// Get the most recent project with its posts for the featured section
const featuredProject = projectsWithLatestPost[0];
const featuredProjectPosts = featuredProject
  ? sortByDate(sortedPosts.filter(post => post.data.project === featuredProject.projectSlug)).slice(0, 4)
  : [];

// Get hero image for component and URL for preloading
const heroImage = getHeroImage(latestPost?.data.heroImage, latestPost?.data.youtubeId);
const heroImageUrl = getHeroImageUrl(latestPost?.data.heroImage, latestPost?.data.youtubeId);
---

<BaseLayout title="The Hobbinomicon">
  {/* Preload LCP hero image */}
  <link slot="head" rel="preload" as="image" href={heroImageUrl} fetchpriority="high" />
  <Header theme="dark" />

  <main id="main-content" class="min-h-screen">
    <!-- Latest Post - Full Screen Hero -->
    {latestPost && (
      <HeroSection
        slug={latestPost.slug}
        title={latestPost.data.title}
        description={latestPost.data.description}
        heroImage={heroImage}
        heroImageAlt={latestPost.data.heroImageAlt}
        category={latestPost.data.category}
        pubDate={latestPost.data.pubDate}
        tags={latestPost.data.tags}
        badge="Latest Post"
        size="large"
      />
    )}

    <!-- Resource Posts Section -->
    <PostGridSection
      title="Resources"
      viewAllLink="/categories/resources"
      posts={resourcePosts}
    />

    <!-- Featured Project Section -->
    {featuredProject && featuredProjectPosts.length > 0 && (
      <FeaturedProjectSection
        projectSlug={featuredProject.projectSlug}
        project={featuredProject.project}
        posts={featuredProjectPosts}
      />
    )}

    <!-- Recent Vlogs Section -->
    <PostGridSection
      title="Recent Vlogs"
      viewAllLink="/blog"
      posts={recentVlogs}
    />

    <!-- Characters Section (hidden for now)
    <CharacterSlider characters={characterPosts} />
    -->

    <!-- YouTube CTA Section -->
    <YouTubeCTA />

    <Footer />
  </main>
</BaseLayout>
