---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import HeroSection from '../components/HeroSection.astro';
import PostCard from '../components/PostCard.astro';
import Footer from '../components/Footer.astro';
import { getHeroImage } from '../utils/getHeroImage';
import { filterDrafts } from '../utils/filterDrafts';
import { formatDateLong } from '../utils/formatDate';
import { getYouTubeFallbackHandler } from '../utils/youtubeImageFallback';

// Get all blog posts and sort by date
const allPosts = await getCollection('blog');
const publishedPosts = filterDrafts(allPosts);
const sortedPosts = publishedPosts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Get the most recent featured post for hero, or fall back to latest post
const featuredPosts = sortedPosts.filter(post => post.data.featured);
const latestPost = featuredPosts[0] || sortedPosts[0];

// Get 6 most recent resource posts
const resourcePosts = sortedPosts
  .filter(post => post.data.category === 'Resources')
  .slice(0, 6);

// Get all projects and their latest posts for the slider
const allProjects = await getCollection('projects');
const publishedProjects = allProjects.filter(project => !project.data.draft);

// For each project, get the latest post
const projectsWithLatestPost = publishedProjects.map(project => {
  const projectSlug = project.id.replace(/\.[^/.]+$/, '');
  const projectPosts = sortedPosts
    .filter(post => post.data.project === projectSlug)
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

  const latestProjectPost = projectPosts[0];

  return {
    project,
    projectSlug,
    latestPost: latestProjectPost,
    latestPostDate: latestProjectPost?.data.pubDate,
  };
}).filter(p => p.latestPost) // Only include projects with posts
  .sort((a, b) => {
    const dateA = a.latestPostDate?.valueOf() || 0;
    const dateB = b.latestPostDate?.valueOf() || 0;
    return dateB - dateA;
  })
  .slice(0, 5); // Limit to 5 projects

// Get recent posts excluding hero, resources, project slider posts, and character posts
const excludedSlugs = new Set([
  latestPost.slug,
  ...resourcePosts.map(p => p.slug),
  ...projectsWithLatestPost.map(p => p.latestPost.slug)
]);
const recentPosts = sortedPosts
  .filter(post => !excludedSlugs.has(post.slug) && post.data.category !== 'Dramatis Personae')
  .slice(0, 6);

// Get character posts
const characterPosts = sortedPosts
  .filter(post => post.data.category === 'Dramatis Personae')
  .slice(0, 6);
---

<BaseLayout title="The Hobbinomicon">
  <Header theme="dark" />

  <div class="min-h-screen">
    <!-- Latest Post - Full Screen Hero -->
    {latestPost && (
      <HeroSection
        slug={latestPost.slug}
        title={latestPost.data.title}
        description={latestPost.data.description}
        heroImage={getHeroImage(latestPost.data.heroImage, latestPost.data.youtubeId)}
        heroImageAlt={latestPost.data.heroImageAlt}
        category={latestPost.data.category}
        pubDate={latestPost.data.pubDate}
        tags={latestPost.data.tags}
        badge="Latest Post"
        size="large"
      />
    )}

    <!-- Resource Posts Section -->
    {resourcePosts.length > 0 && (
      <section class="bg-parchment py-16 md:py-24">
        <div class="max-w-7xl mx-auto px-6">
          <div class="flex items-center justify-between mb-12">
            <h2 class="text-4xl md:text-5xl font-heading font-bold text-ink">Resources</h2>
            <a href="/categories/resources" class="text-ink hover:underline underline-offset-4 transition-all">
              View All →
            </a>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {resourcePosts.map((post, index) => (
              <PostCard
                slug={post.slug}
                title={post.data.title}
                description={post.data.description}
                heroImage={post.data.heroImage}
                heroImageAlt={post.data.heroImageAlt}
                category={post.data.category}
                pubDate={post.data.pubDate}
                tags={post.data.tags}
                youtubeId={post.data.youtubeId}
                eager={index < 3}
              />
            ))}
          </div>
        </div>
      </section>
    )}

    <!-- Projects Slider -->
    {projectsWithLatestPost.length > 0 && (
      <section class="group relative h-screen overflow-hidden bg-ink" id="project-slider" aria-label="Featured Projects Carousel">
        <div class="featured-slides relative h-full">
          {projectsWithLatestPost.map(({ project, projectSlug, latestPost: post }, index) => (
            <div
              class={`featured-slide absolute inset-0 transition-opacity duration-1000 ${index === 0 ? 'opacity-100' : 'opacity-0'}`}
              data-slide={index}
              role="group"
              aria-roledescription="slide"
              aria-label={`${index + 1} of ${projectsWithLatestPost.length}: ${post.data.title}`}
              aria-hidden={index !== 0}
            >
              <img
                src={getHeroImage(post.data.heroImage, post.data.youtubeId)}
                alt={post.data.heroImageAlt || post.data.title}
                class="absolute inset-0 w-full h-full object-cover"
                loading={index === 0 ? 'eager' : 'lazy'}
                decoding="async"
                fetchpriority={index === 0 ? 'high' : 'auto'}
                data-youtube-url={getHeroImage(post.data.heroImage, post.data.youtubeId).includes('youtube.com') ? getHeroImage(post.data.heroImage, post.data.youtubeId) : undefined}
                onerror={getYouTubeFallbackHandler('url')}
              />
              <div class="absolute inset-0 bg-gradient-to-t from-ink via-ink/50 to-transparent"></div>

              <div class="absolute bottom-0 left-0 right-0">
                <div class="max-w-7xl mx-auto px-6 pb-24">
                <div class="mb-4">
                  <a href={`/projects/${projectSlug}`} class="inline-block px-4 py-2 bg-white/20 backdrop-blur-md text-white text-sm font-medium rounded-full hover:bg-white/30 transition-colors">
                    {project.data.title}
                  </a>
                </div>
                <h2 class="text-4xl md:text-5xl lg:text-6xl font-heading font-bold text-white mb-4 drop-shadow-2xl">
                  {post.data.title}
                </h2>
                <p class="text-xl text-white/90 mb-6 drop-shadow-lg">
                  {post.data.description}
                </p>
                <div class="flex flex-wrap gap-4 text-white/80 text-sm mb-6">
                  <span class="px-3 py-1 bg-white/20 backdrop-blur-sm rounded">{post.data.category}</span>
                  <time datetime={post.data.pubDate.toISOString()}>
                    {formatDateLong(post.data.pubDate)}
                  </time>
                </div>
                <a
                  href={`/blog/${post.slug}`}
                  class="inline-block px-6 py-3 bg-white text-ink font-medium rounded hover:bg-white/90 transition-colors"
                >
                  Read More
                </a>
                </div>
              </div>
            </div>
          ))}
        </div>

        <!-- Previous/Next Navigation Buttons -->
        <button
          class="slider-prev absolute left-4 md:left-8 top-1/2 -translate-y-1/2 z-20 w-12 h-12 md:w-14 md:h-14 flex items-center justify-center bg-white/10 hover:bg-white/30 backdrop-blur-md rounded-full transition-all md:opacity-0 md:group-hover:opacity-100 focus:opacity-100"
          aria-label="Previous slide"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
          </svg>
        </button>
        <button
          class="slider-next absolute right-4 md:right-8 top-1/2 -translate-y-1/2 z-20 w-12 h-12 md:w-14 md:h-14 flex items-center justify-center bg-white/10 hover:bg-white/30 backdrop-blur-md rounded-full transition-all md:opacity-0 md:group-hover:opacity-100 focus:opacity-100"
          aria-label="Next slide"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </button>

        <!-- Slider Dots Navigation -->
        <div class="absolute bottom-8 left-0 right-0 flex justify-center gap-3 z-10" role="group" aria-label="Slide navigation">
          {projectsWithLatestPost.map((_, index) => (
            <button
              class={`slider-dot w-3 h-3 rounded-full transition-all hover:scale-125 focus:scale-125 focus:outline-none focus:ring-2 focus:ring-white focus:ring-offset-2 focus:ring-offset-ink ${index === 0 ? 'bg-white w-8' : 'bg-white/50'}`}
              data-slide={index}
              aria-label={`Go to slide ${index + 1}`}
              aria-current={index === 0}
            />
          ))}
        </div>

        <!-- Pause/Play Button -->
        <button
          class="slider-pause absolute top-24 md:top-28 right-4 md:right-8 z-20 w-10 h-10 flex items-center justify-center bg-white/10 hover:bg-white/20 backdrop-blur-md rounded-full transition-all"
          aria-label="Pause autoplay"
        >
          <svg class="pause-icon h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <svg class="play-icon h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </button>

        <script>
          // Ensure DOM is ready
          document.addEventListener('DOMContentLoaded', function() {
            const slides = document.querySelectorAll('.featured-slide');
            const dots = document.querySelectorAll('.slider-dot');
            const sliderSection = document.getElementById('project-slider');
            const prevButton = document.querySelector('.slider-prev');
            const nextButton = document.querySelector('.slider-next');
            const pauseButton = document.querySelector('.slider-pause');
            const pauseIcon = document.querySelector('.pause-icon');
            const playIcon = document.querySelector('.play-icon');

            // Guard clause - exit if elements don't exist
            if (!slides.length || !dots.length || !sliderSection) {
              return;
            }

            let currentSlide = 0;
            let isScrolling = false;
            let autoAdvanceInterval;
            let isPaused = false;

            function showSlide(index) {
              // Update slides
              slides.forEach((slide, i) => {
                const isActive = i === index;
                slide.classList.toggle('opacity-100', isActive);
                slide.classList.toggle('opacity-0', !isActive);
                slide.setAttribute('aria-hidden', !isActive);
              });

              // Update dots
              dots.forEach((dot, i) => {
                const isActive = i === index;
                if (isActive) {
                  dot.classList.add('bg-white', 'w-8');
                  dot.classList.remove('bg-white/50');
                  dot.setAttribute('aria-current', 'true');
                } else {
                  dot.classList.remove('bg-white', 'w-8');
                  dot.classList.add('bg-white/50');
                  dot.setAttribute('aria-current', 'false');
                }
              });

              currentSlide = index;

              // Update button states
              updateButtonStates();
            }

            function updateButtonStates() {
              // Always allow cycling, so buttons are never disabled
              // But we could add visual feedback here if needed
            }

            function nextSlide() {
              const next = (currentSlide + 1) % slides.length;
              showSlide(next);
              return true;
            }

            function prevSlide() {
              const prev = currentSlide === 0 ? slides.length - 1 : currentSlide - 1;
              showSlide(prev);
              return true;
            }

            function startAutoAdvance() {
              if (isPaused) return;
              stopAutoAdvance(); // Clear any existing interval
              autoAdvanceInterval = setInterval(() => {
                nextSlide();
              }, 5000);
            }

            function stopAutoAdvance() {
              clearInterval(autoAdvanceInterval);
            }

            function togglePause() {
              isPaused = !isPaused;

              if (isPaused) {
                stopAutoAdvance();
                pauseIcon.classList.add('hidden');
                playIcon.classList.remove('hidden');
                pauseButton.setAttribute('aria-label', 'Play autoplay');
              } else {
                startAutoAdvance();
                pauseIcon.classList.remove('hidden');
                playIcon.classList.add('hidden');
                pauseButton.setAttribute('aria-label', 'Pause autoplay');
              }
            }

            // Previous/Next button handlers
            if (prevButton) {
              prevButton.addEventListener('click', () => {
                prevSlide();
                stopAutoAdvance();
                if (!isPaused) {
                  startAutoAdvance();
                }
              });
            }

            if (nextButton) {
              nextButton.addEventListener('click', () => {
                nextSlide();
                stopAutoAdvance();
                if (!isPaused) {
                  startAutoAdvance();
                }
              });
            }

            // Pause/Play button handler
            if (pauseButton) {
              pauseButton.addEventListener('click', togglePause);
            }

            // Dot click handlers
            dots.forEach((dot, index) => {
              dot.addEventListener('click', () => {
                showSlide(index);
                stopAutoAdvance();
                if (!isPaused) {
                  startAutoAdvance();
                }
              });
            });

            // Keyboard navigation
            if (sliderSection) {
              sliderSection.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft') {
                  e.preventDefault();
                  prevSlide();
                  stopAutoAdvance();
                  if (!isPaused) {
                    startAutoAdvance();
                  }
                } else if (e.key === 'ArrowRight') {
                  e.preventDefault();
                  nextSlide();
                  stopAutoAdvance();
                  if (!isPaused) {
                    startAutoAdvance();
                  }
                } else if (e.key === ' ' || e.key === 'Spacebar') {
                  e.preventDefault();
                  togglePause();
                }
              });

              // Pause on hover
              sliderSection.addEventListener('mouseenter', () => {
                if (!isPaused) {
                  stopAutoAdvance();
                }
              });

              sliderSection.addEventListener('mouseleave', () => {
                if (!isPaused) {
                  startAutoAdvance();
                }
              });

              // Touch swipe support
              let touchStartX = 0;
              let touchEndX = 0;

              sliderSection.addEventListener('touchstart', (e) => {
                touchStartX = e.changedTouches[0].screenX;
              }, { passive: true });

              sliderSection.addEventListener('touchend', (e) => {
                touchEndX = e.changedTouches[0].screenX;
                handleSwipe();
              }, { passive: true });

              function handleSwipe() {
                const swipeThreshold = 50;
                const diff = touchStartX - touchEndX;

                if (Math.abs(diff) > swipeThreshold) {
                  if (diff > 0) {
                    // Swiped left - next slide
                    nextSlide();
                  } else {
                    // Swiped right - previous slide
                    prevSlide();
                  }
                  stopAutoAdvance();
                  if (!isPaused) {
                    startAutoAdvance();
                  }
                }
              }
            }

            // Start autoplay
            startAutoAdvance();

            // Pause autoplay when page is not visible
            document.addEventListener('visibilitychange', () => {
              if (document.hidden) {
                stopAutoAdvance();
              } else if (!isPaused) {
                startAutoAdvance();
              }
            });
          });
        </script>
      </section>
    )}

    <!-- Recent Posts Section -->
    {recentPosts.length > 0 && (
      <section class="bg-parchment py-16 md:py-24">
        <div class="max-w-7xl mx-auto px-6">
          <div class="flex items-center justify-between mb-12">
            <h2 class="text-4xl md:text-5xl font-heading font-bold text-ink">More Posts</h2>
            <a href="/blog" class="text-ink hover:underline underline-offset-4 transition-all">
              View All →
            </a>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {recentPosts.map((post, index) => (
              <PostCard
                slug={post.slug}
                title={post.data.title}
                description={post.data.description}
                heroImage={post.data.heroImage}
                heroImageAlt={post.data.heroImageAlt}
                category={post.data.category}
                pubDate={post.data.pubDate}
                tags={post.data.tags}
                youtubeId={post.data.youtubeId}
                eager={index < 3}
              />
            ))}
          </div>
        </div>
      </section>
    )}

    <!-- Characters Section -->
    {characterPosts.length > 0 && (
      <section class="bg-ink py-16 md:py-24">
        <div class="max-w-7xl mx-auto px-6">
          <div class="flex items-center justify-between mb-12">
            <h2 class="text-4xl md:text-5xl font-heading font-bold text-white">Dramatis Personae</h2>
            <a href="/categories/dramatis-personae" class="text-white hover:underline underline-offset-4 transition-all">
              View All →
            </a>
          </div>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-6">
            {characterPosts.map((character) => (
              <a
                href={`/blog/${character.slug}`}
                class="character-card group relative aspect-[1/2] overflow-hidden rounded-lg"
              >
                <img
                  src={character.data.heroImage || '/images/placeholder.jpg'}
                  alt={character.data.heroImageAlt || character.data.title}
                  class="absolute inset-0 w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
                />
                <div class="absolute inset-0 bg-gradient-to-t from-ink via-ink/50 to-transparent opacity-40 group-hover:opacity-80 transition-opacity duration-500"></div>
                <div class="absolute inset-0 flex items-end justify-center p-6 opacity-0 group-hover:opacity-100 transition-opacity duration-500">
                  <h3 class="text-2xl md:text-3xl font-heading font-bold text-white text-center drop-shadow-2xl">
                    {character.data.title}
                  </h3>
                </div>
              </a>
            ))}
          </div>
        </div>
      </section>
    )}

    <!-- YouTube CTA Section -->
    <section class="bg-parchment py-24 md:py-32">
      <div class="max-w-4xl mx-auto px-6 text-center">
        <div class="mb-8">
          <svg class="w-20 h-20 mx-auto text-ink opacity-80" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
          </svg>
        </div>
        <h2 class="text-4xl md:text-6xl font-heading font-bold text-ink mb-6">
          Join me in the Dungeon
        </h2>
        <p class="text-xl md:text-2xl text-ink/80 mb-8 leading-relaxed">
          Join me on YouTube for painting tutorials, hobby vlogs, battle reports, and to follow my journey to become a Golden Daemon winning painter.
        </p>
        <a
          href="https://www.youtube.com/@Hobbinomicon"
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-3 px-8 py-4 bg-ink text-parchment font-heading font-bold text-lg rounded-lg hover:bg-ink/90 transition-all hover:scale-105 shadow-lg"
        >
          <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
          </svg>
          Subscribe on YouTube
        </a>
        <p class="text-sm text-ink/60 mt-6">
          New videos every day
        </p>
      </div>
    </section>

    <Footer />
  </div>
</BaseLayout>
