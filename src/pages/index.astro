---
import { getCollection } from 'astro:content';
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/Header.astro';
import HeroSection from '../components/HeroSection.astro';
import PostGridSection from '../components/PostGridSection.astro';
import FeaturedProjectSection from '../components/FeaturedProjectSection.astro';
import CharacterSlider from '../components/CharacterSlider.astro';
import YouTubeCTA from '../components/YouTubeCTA.astro';
import Footer from '../components/Footer.astro';
import ContentContainer from '../components/ContentContainer.astro';
import PostCard from '../components/PostCard.astro';
import ResourceThumbnail from '../components/ResourceThumbnail.astro';
import ViewAllLink from '../components/ViewAllLink.astro';
import { getHeroImage, getHeroImageUrl } from '../utils/getHeroImage';
import { getPublishedPosts, sortByDate } from '../utils/collections';
import { getTagDisplay } from '../utils/tags';

// Get all blog posts and sort by date
const allPosts = await getCollection('blog');
const publishedPosts = getPublishedPosts(allPosts);
const sortedPosts = publishedPosts;

// Get the most recent featured post for hero, or fall back to latest post
const featuredPosts = sortedPosts.filter(post => post.data.featured);
const latestPost = featuredPosts[0] || sortedPosts[0];

// Get all resource posts and separate hubs from individual resources
const allResourcePosts = sortedPosts.filter(post => post.data.category === 'Resources');

// Hub pages (resourceType: "hub") - these get full cards
const resourceHubs = allResourcePosts.filter(post => post.data.resourceType === 'hub');

// Individual resources (guides, articles, checklists) AND articles from Articles category - these get thumbnails
const resourceItems = allResourcePosts.filter(post => post.data.resourceType && post.data.resourceType !== 'hub');
const articleCategoryPosts = sortedPosts.filter(post => post.data.category === 'Articles');
const individualResources = [...resourceItems, ...articleCategoryPosts]
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
  .slice(0, 6);

// Get all projects and their latest posts
const allProjects = await getCollection('projects');
const publishedProjects = allProjects.filter(project => !project.data.draft);

// For each project, get the latest post
const projectsWithLatestPost = publishedProjects.map(project => {
  const projectSlug = project.id.replace(/\.[^/.]+$/, '');
  const projectPosts = sortByDate(sortedPosts.filter(post => post.data.project === projectSlug));
  const latestProjectPost = projectPosts[0];

  return {
    project,
    projectSlug,
    latestPost: latestProjectPost,
    latestPostDate: latestProjectPost?.data.pubDate,
  };
}).filter(p => p.latestPost)
  .sort((a, b) => {
    const dateA = a.latestPostDate?.valueOf() || 0;
    const dateB = b.latestPostDate?.valueOf() || 0;
    return dateB - dateA;
  })
  .slice(0, 5);

// Get recent posts excluding hero, resources, and featured project posts
const excludedSlugs = new Set([
  latestPost.slug,
  ...resourceHubs.map(p => p.slug),
  ...individualResources.map(p => p.slug),
  ...projectsWithLatestPost.map(p => p.latestPost.slug)
]);

// Get Kingdom Death posts - latest episode for featured section
const kingdomDeathPosts = sortedPosts
  .filter(post => post.data.tags?.includes('kdm-hesychia') && post.data.youtubeId);
const latestKDMPost = kingdomDeathPosts[0];

// Get recent vlog posts (posts with YouTube videos) - only 3 for homepage, excluding Kingdom Death
const recentVlogs = sortedPosts
  .filter(post => !excludedSlugs.has(post.slug) && post.data.youtubeId && !post.data.tags?.includes('kingdom-death'))
  .slice(0, 3);

// Painting technique tags to filter by
const paintingTags = ['painting', 'glazing', 'dry-brushing', 'airbrushing', 'contrast-paints', 'zenithal', 'blending', 'washes', 'nmm', 'edge-highlighting', 'preshading', 'speed-painting'];

// Get painting tutorials - posts with painting-related tags
const paintingTutorials = sortedPosts
  .filter(post => !excludedSlugs.has(post.slug) &&
    post.data.tags?.some(tag => paintingTags.includes(tag)))
  .slice(0, 6);

// Hobby tags to filter by
const hobbyTags = ['building', 'model-prep', '3d-printing', 'terrain', 'basing', 'priming', 'resin-casting', 'kitbashing', 'magnetizing'];

// Get hobby posts - posts with hobby-related tags
const hobbyPosts = sortedPosts
  .filter(post => !excludedSlugs.has(post.slug) &&
    !paintingTutorials.some(p => p.slug === post.slug) &&
    post.data.tags?.some(tag => hobbyTags.includes(tag)))
  .slice(0, 6);

// Game system tags for the games section
const gameSystemTags = ['warmachine', 'warhammer', 'trench-crusade', 'mage-knight', 'crown-and-skull', 'necromunda', 'dolmenwood', 'motley-crews', 'kingdom-death'];

// Get character posts sorted by most recently updated
const characterPosts = publishedPosts
  .filter(post => post.data.category === 'Dramatis Personae')
  .sort((a, b) => {
    const dateA = (a.data.updatedDate || a.data.pubDate).valueOf();
    const dateB = (b.data.updatedDate || b.data.pubDate).valueOf();
    return dateB - dateA;
  })
  .slice(0, 9);

// Get most recent Campaign Chronicles post for hero section
const campaignChroniclesPosts = sortedPosts
  .filter(post => post.data.category === 'Campaign Chronicles');
const latestCampaignPost = campaignChroniclesPosts[0];
const campaignHeroImage = latestCampaignPost ? getHeroImage(latestCampaignPost.data.heroImage, latestCampaignPost.data.youtubeId) : null;

// Get the most recent project with its posts for the featured section
const featuredProject = projectsWithLatestPost[0];
const featuredProjectPosts = featuredProject
  ? sortByDate(sortedPosts.filter(post => post.data.project === featuredProject.projectSlug)).slice(0, 4)
  : [];

// Get hero image for component and URL for preloading
const heroImage = getHeroImage(latestPost?.data.heroImage, latestPost?.data.youtubeId);
const heroImageUrl = getHeroImageUrl(latestPost?.data.heroImage, latestPost?.data.youtubeId);
---

<BaseLayout title="The Hobbinomicon">
  {/* Preload LCP hero image */}
  <link slot="head" rel="preload" as="image" href={heroImageUrl} fetchpriority="high" />
  <Header theme="dark" />

  <main id="main-content" class="min-h-screen">
    <!-- Featured Post - Full Screen Hero -->
    {latestPost && (
      <HeroSection
        slug={latestPost.slug}
        title={latestPost.data.title}
        description={latestPost.data.description}
        heroImage={heroImage}
        heroImageAlt={latestPost.data.heroImageAlt}
        category={latestPost.data.category}
        pubDate={latestPost.data.pubDate}
        tags={latestPost.data.tags}
        badge="Featured Post"
        size="large"
      />
    )}

    <!-- Resource Posts Section -->
    {(resourceHubs.length > 0 || individualResources.length > 0) && (
      <section class="bg-parchment dark:bg-parchment-dark py-16 md:py-24">
        <ContentContainer>
          <div class="flex items-center justify-between mb-12">
            <h2 class="text-4xl md:text-5xl font-heading font-bold text-ink dark:text-ink-dark">Resources</h2>
            <ViewAllLink href="/categories/resources">View All →</ViewAllLink>
          </div>

          {/* Resource Hub Cards */}
          {resourceHubs.length > 0 && (
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-12">
              {resourceHubs.map((post) => (
                <PostCard post={post} />
              ))}
            </div>
          )}

          {/* Individual Resource Thumbnails */}
          {individualResources.length > 0 && (
            <div>
              <h3 class="text-xl font-heading font-semibold text-ink dark:text-ink-dark mb-6">Recent Guides & Articles</h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {individualResources.map((post) => (
                  <ResourceThumbnail post={post} />
                ))}
              </div>
            </div>
          )}
        </ContentContainer>
      </section>
    )}

    <!-- Featured Project Section -->
    {featuredProject && featuredProjectPosts.length > 0 && (
      <FeaturedProjectSection
        projectSlug={featuredProject.projectSlug}
        project={featuredProject.project}
        posts={featuredProjectPosts}
      />
    )}

    <!-- Recent Vlogs Section -->
    <PostGridSection
      title="Recent Vlogs"
      viewAllLink="/categories/vlogs"
      posts={recentVlogs}
    />

    <!-- Kingdom Death Campaign Callout -->
    {latestKDMPost && (
      <section class="bg-ink dark:bg-ink-dark py-16 md:py-24 relative overflow-hidden">
        {/* Gradient overlay */}
        <div class="absolute inset-0 bg-gradient-to-br from-ink/50 via-transparent to-red-900/20 dark:from-ink-dark/50 dark:to-red-900/30"></div>

        <ContentContainer class="relative z-10">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12 items-center">
            {/* Video Thumbnail */}
            <a href={`/blog/${latestKDMPost.slug}`} class="group block relative aspect-video rounded-xl overflow-hidden shadow-2xl">
              <img
                src={`https://img.youtube.com/vi/${latestKDMPost.data.youtubeId}/maxresdefault.jpg`}
                alt={latestKDMPost.data.title}
                class="absolute inset-0 w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
              />
              <div class="absolute inset-0 bg-gradient-to-t from-ink/80 via-ink/20 to-transparent"></div>
              {/* Play button */}
              <div class="absolute inset-0 flex items-center justify-center">
                <div class="w-20 h-20 bg-red-600 rounded-full flex items-center justify-center group-hover:scale-110 transition-transform duration-300 shadow-lg">
                  <svg class="w-8 h-8 text-white ml-1" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M8 5v14l11-7z"/>
                  </svg>
                </div>
              </div>
              {/* Episode title */}
              <div class="absolute bottom-0 left-0 right-0 p-4">
                <span class="text-red-400 text-sm font-semibold uppercase tracking-wider">Latest Episode</span>
                <h3 class="text-white text-xl font-heading font-bold mt-1 group-hover:text-red-300 transition-colors">
                  {latestKDMPost.data.title}
                </h3>
              </div>
            </a>

            {/* Campaign Info */}
            <div class="text-parchment dark:text-parchment-dark">
              <h2 class="text-4xl md:text-5xl font-heading font-bold mb-4">
                Kingdom Death: Monster
              </h2>
              <p class="text-parchment/80 dark:text-parchment-dark/80 text-lg mb-6">
                Follow the settlement of <span class="text-red-400 font-semibold">Hesychia</span> as survivors struggle against the horrors of the Monster universe.
              </p>

              {/* Settlement Stats */}
              <div class="grid grid-cols-4 gap-3 mb-8">
                <div class="bg-parchment/10 dark:bg-parchment-dark/10 rounded-lg p-3 text-center">
                  <div class="text-2xl font-bold text-parchment dark:text-parchment-dark">Year 2</div>
                  <div class="text-xs text-parchment/60 dark:text-parchment-dark/60 uppercase tracking-wider">Lantern Year</div>
                </div>
                <div class="bg-parchment/10 dark:bg-parchment-dark/10 rounded-lg p-3 text-center">
                  <div class="text-2xl font-bold text-parchment dark:text-parchment-dark">7</div>
                  <div class="text-xs text-parchment/60 dark:text-parchment-dark/60 uppercase tracking-wider">Survivors</div>
                </div>
                <div class="bg-parchment/10 dark:bg-parchment-dark/10 rounded-lg p-3 text-center">
                  <div class="text-2xl font-bold text-red-400">2</div>
                  <div class="text-xs text-parchment/60 dark:text-parchment-dark/60 uppercase tracking-wider">Deaths</div>
                </div>
                <div class="bg-parchment/10 dark:bg-parchment-dark/10 rounded-lg p-3 text-center">
                  <div class="text-2xl font-bold text-red-400">1</div>
                  <div class="text-xs text-parchment/60 dark:text-parchment-dark/60 uppercase tracking-wider">Lost</div>
                </div>
              </div>

              {/* CTAs */}
              <div class="flex flex-col sm:flex-row gap-4">
                <a
                  href="https://www.youtube.com/playlist?list=PL_eOMhOeZbWV2neK_wPFPfUg3GUYZLv7o"
                  target="_blank"
                  rel="noopener noreferrer"
                  class="inline-flex items-center justify-center gap-2 px-6 py-3 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition-colors"
                >
                  <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23 0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23 0 3.897-.266 4.356-2.62 4.385-8.816-.029-6.185-.484-8.549-4.385-8.816zm-10.615 12.816v-8l8 3.993-8 4.007z"/>
                  </svg>
                  Watch From the Start
                </a>
                <a
                  href="/blog/campaigns/kingdom-death/settlement-1"
                  class="inline-flex items-center justify-center gap-2 px-6 py-3 bg-parchment/10 hover:bg-parchment/20 dark:bg-parchment-dark/10 dark:hover:bg-parchment-dark/20 text-parchment dark:text-parchment-dark font-semibold rounded-lg transition-colors border border-parchment/20 dark:border-parchment-dark/20"
                >
                  View Campaign Details
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                  </svg>
                </a>
              </div>
            </div>
          </div>
        </ContentContainer>
      </section>
    )}

    <!-- Painting Tutorials Section -->
    {paintingTutorials.length > 0 && (
      <section class="bg-parchment dark:bg-parchment-dark py-16 md:py-24">
        <ContentContainer>
          <div class="flex items-center justify-between mb-12">
            <h2 class="text-4xl md:text-5xl font-heading font-bold text-ink dark:text-ink-dark">Painting Tutorials</h2>
            <ViewAllLink href="/tags/painting">View All →</ViewAllLink>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {paintingTutorials.map((post) => (
              <ResourceThumbnail post={post} />
            ))}
          </div>
        </ContentContainer>
      </section>
    )}

    <!-- Hobby Section -->
    {hobbyPosts.length > 0 && (
      <section class="bg-parchment dark:bg-parchment-dark py-16 md:py-24">
        <ContentContainer>
          <div class="flex items-center justify-between mb-12">
            <h2 class="text-4xl md:text-5xl font-heading font-bold text-ink dark:text-ink-dark">Hobby</h2>
            <ViewAllLink href="/tags/building">View All →</ViewAllLink>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            {hobbyPosts.map((post) => (
              <ResourceThumbnail post={post} />
            ))}
          </div>
        </ContentContainer>
      </section>
    )}

    <!-- Games Section -->
    <section class="bg-parchment dark:bg-parchment-dark py-16 md:py-24">
      <ContentContainer>
        <div class="flex items-center justify-between mb-12">
          <h2 class="text-4xl md:text-5xl font-heading font-bold text-ink dark:text-ink-dark">Games</h2>
          <ViewAllLink href="/tags">Browse All Tags →</ViewAllLink>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          {gameSystemTags.map((tag) => (
            <a
              href={`/tags/${tag}`}
              class="group block p-6 bg-ink/5 dark:bg-ink-dark/5 rounded-xl border border-ink/10 dark:border-ink-dark/10 hover:bg-ink/10 dark:hover:bg-ink-dark/10 hover:border-ink/20 dark:hover:border-ink-dark/20 transition-all"
            >
              <span class="text-lg font-heading font-semibold text-ink dark:text-ink-dark group-hover:underline underline-offset-2">
                {getTagDisplay(tag)}
              </span>
            </a>
          ))}
        </div>
      </ContentContainer>
    </section>

    <!-- Campaign Chronicles Section -->
    {latestCampaignPost && campaignHeroImage && (
      <HeroSection
        slug={latestCampaignPost.slug}
        title={latestCampaignPost.data.title}
        description={latestCampaignPost.data.description}
        heroImage={campaignHeroImage}
        heroImageAlt={latestCampaignPost.data.heroImageAlt}
        category={latestCampaignPost.data.category}
        pubDate={latestCampaignPost.data.pubDate}
        tags={latestCampaignPost.data.tags}
        badge="Campaign Chronicles"
        size="medium"
      />
    )}

    <!-- Dramatis Personae Section -->
    <CharacterSlider characters={characterPosts} />

    <!-- YouTube CTA Section -->
    <YouTubeCTA />

    <Footer />
  </main>
</BaseLayout>
