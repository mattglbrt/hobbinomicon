---
import BaseLayout from "../layouts/BaseLayout.astro";
import HeroBanner from "../components/HeroBanner.astro";
import GameCard from "../components/GameCard.astro";
import BlogPostCard from "../components/BlogPostCard.astro";
import FeaturedBanner from "../components/FeaturedBanner.astro";
import CategorySection from "../components/CategorySection.astro";

import { supabase } from "../lib/supabase";
import { getCollection } from "astro:content";

const { data: games, error } = await supabase.from("games").select("*");

const posts = await getCollection("blog");
const newsPosts = posts.filter((post) => post.data.category === "News").slice(0, 6);

// Pick featured game manually for now
const featuredGame = games?.find(game => game.slug === "warmachine") || games?.[0] || null;
---

<BaseLayout>
  <HeroBanner />

  <section class="py-12">
    <div class="max-w-7xl mx-auto px-4">
      <h2 class="text-3xl md:text-4xl font-bold mb-8 text-center">Recently Updated Games</h2>
      <div class="grid md:grid-cols-3 gap-8">
        {games?.length > 0 ? (
          games.slice(0, 3).map((game) => (
            <GameCard game={game} />
          ))
        ) : (
          <p class="text-center text-gray-500">No games found.</p>
        )}
      </div>
    </div>
  </section>

  <section class="py-12 bg-gray-100">
    <div class="max-w-7xl mx-auto px-4">
      <h2 class="text-3xl md:text-4xl font-bold mb-8 text-center">Latest News</h2>
      <div class="grid md:grid-cols-3 gap-8">
        {newsPosts.map((post) => (
          <BlogPostCard post={post} />
        ))}
      </div>
    </div>
  </section>

  {featuredGame && (
    <FeaturedBanner game={featuredGame} />
  )}

  <CategorySection title="Guides" posts={posts.filter((post) => post.data.category === "Guides").slice(0, 6)} />
  <CategorySection title="Reviews" posts={posts.filter((post) => post.data.category === "Reviews").slice(0, 6)} />
  <CategorySection title="Hobby Log" posts={posts.filter((post) => post.data.category === "Hobby Log").slice(0, 6)} />
</BaseLayout>
