---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getEntryBySlug, getCollection } from "astro:content";
import TableOfContents from "../../components/TableOfContents";

export const prerender = true; // ✅ Add this line to fix the warning

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({
    params: { slug: post.slug },
  }));
}

const { slug } = Astro.params;
const postEntry = await getEntryBySlug('blog', slug);

if (!postEntry) {
  throw new Error(`Post not found for slug: ${slug}`);
}

const { Content, headings } = await postEntry.render();


// Get all posts for next/prev navigation
const posts = await getCollection('blog');
const index = posts.findIndex((p) => p.slug === slug);
const prevPost = index > 0 ? posts[index - 1] : null;
const nextPost = index < posts.length - 1 ? posts[index + 1] : null;

// Calculate reading time
function calculateReadingTime(bodyText) {
  const wordsPerMinute = 200;
  const words = bodyText.trim().split(/\s+/).length;
  const time = Math.ceil(words / wordsPerMinute);
  return time;
}
const readingTime = postEntry.body ? calculateReadingTime(postEntry.body) : 0;

---

<BaseLayout title={`${postEntry.data.title} | Hobbinomicon`}>
  <section class="py-12">
    <div class="max-w-6xl mx-auto px-4 grid grid-cols-1 md:grid-cols-4 gap-8">

      <div class="md:col-span-3">
        <!-- Breadcrumbs -->
        <nav class="text-sm mb-6 text-gray-500">
          <a href="/" class="hover:text-red-600">Home</a> &rsaquo; 
          <a href="/blog" class="hover:text-red-600">Blog</a> &rsaquo; 
          <span class="text-gray-900">{postEntry.data.title}</span>
        </nav>

        <!-- Post Header -->
        <h1 class="text-4xl font-bold mb-2">{postEntry.data.title}</h1>
        <p class="text-gray-500 text-sm mb-4">
          {postEntry.data.pubDate ? new Date(postEntry.data.pubDate).toLocaleDateString() : ''} 
          {readingTime ? ` • ${readingTime} min read` : ''}
        </p>

        {postEntry.data.featuredImage && (
          <img src={postEntry.data.featuredImage} alt={postEntry.data.title} class="rounded-lg mb-8 w-full" />
        )}

        <!-- Post Content -->
        <article class="prose prose-lg max-w-none">
          <Content />
        </article>

        <!-- Next/Previous Navigation -->
        <div class="flex justify-between items-center mt-12 border-t pt-8">
          {prevPost && (
            <a href={`/blog/${prevPost.slug}`} class="text-red-600 hover:underline">
              ← {prevPost.data.title}
            </a>
          )}
          {nextPost && (
            <a href={`/blog/${nextPost.slug}`} class="text-red-600 hover:underline ml-auto">
              {nextPost.data.title} →
            </a>
          )}
        </div>
      </div>

      <!-- Sidebar (TOC can go here later) -->
      <aside class="hidden md:block sticky top-24">
        <h2 class="text-xl font-bold mb-4">Table of Contents</h2>
        <TableOfContents headings={headings.map(({ slug, text, depth }) => ({ slug, text, depth }))} client:only="react" />

      </aside>
      

    </div>
  </section>
</BaseLayout>
