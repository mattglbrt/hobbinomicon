---
import { Image } from 'astro:assets';
import type { CollectionEntry } from 'astro:content';
import { getHeroImage, isImageMetadata } from '../utils/getHeroImage';
import { formatDateShort } from '../utils/formatDate';
import { getYouTubeFallbackHandler } from '../utils/youtubeImageFallback';

// Support both individual props OR a post object
type IndividualProps = {
  post?: never;
  slug: string;
  title: string;
  description: string;
  heroImage?: string;
  heroImageAlt?: string;
  category: string;
  pubDate: Date;
  tags?: string[];
  youtubeId?: string;
};

type PostObjectProps = {
  post: CollectionEntry<'blog'>;
  slug?: never;
  title?: never;
  description?: never;
  heroImage?: never;
  heroImageAlt?: never;
  category?: never;
  pubDate?: never;
  tags?: never;
  youtubeId?: never;
};

interface CommonProps {
  showCategory?: boolean;
  eager?: boolean;
}

type Props = CommonProps & (IndividualProps | PostObjectProps);

const props = Astro.props;

// Extract values from either post object or individual props
const slug = props.post?.slug ?? props.slug!;
const title = props.post?.data.title ?? props.title!;
const description = props.post?.data.description ?? props.description!;
const heroImage = props.post?.data.heroImage ?? props.heroImage;
const heroImageAlt = props.post?.data.heroImageAlt ?? props.heroImageAlt;
const category = props.post?.data.category ?? props.category!;
const pubDate = props.post?.data.pubDate ?? props.pubDate!;
const tags = props.post?.data.tags ?? props.tags ?? [];
const youtubeId = props.post?.data.youtubeId ?? props.youtubeId;
const showCategory = props.showCategory ?? true;
const eager = props.eager ?? false;

const displayImage = getHeroImage(heroImage, youtubeId);

// Determine image type for rendering
const isOptimizedImage = isImageMetadata(displayImage);
const isRemoteImage = !isOptimizedImage && typeof displayImage === 'string' && displayImage.startsWith('http');

const formattedDate = formatDateShort(pubDate);
---

<style>
  .image-wrapper img {
    animation: fadeIn 0.3s ease-in;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  /* Blur-up effect for loading images */
  .image-loading {
    backdrop-filter: blur(10px);
    background: linear-gradient(to bottom, #e5d5c1, #d4c4b0);
    transition: opacity 0.3s ease-out;
  }

  .image-loading.loaded {
    opacity: 0;
    pointer-events: none;
  }
</style>

<article class="group">
  <a href={`/blog/${slug}`} class="block">
    <div class="relative overflow-hidden rounded-lg mb-4 aspect-[4/3] image-wrapper">
      <div class="absolute inset-0 image-loading" data-placeholder></div>
      {isOptimizedImage ? (
        <!-- Optimized image from hero-cache (ImageMetadata) -->
        <Image
          src={displayImage}
          alt={heroImageAlt || title}
          width={800}
          height={600}
          class="w-full h-full object-cover img-hover"
          loading={eager ? 'eager' : 'lazy'}
          decoding="async"
          format="webp"
          quality={65}
          widths={[300, 400, 800]}
          sizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 400px"
          onload="this.closest('.image-wrapper').querySelector('[data-placeholder]').classList.add('loaded')"
        />
      ) : isRemoteImage ? (
        <!-- Remote image (YouTube fallback) -->
        <picture>
          <source
            srcset={displayImage}
            type="image/webp"
            media="(min-width: 768px)"
          />
          <source
            srcset={displayImage}
            type="image/jpeg"
          />
          <img
            src={displayImage}
            alt={heroImageAlt || title}
            class="w-full h-full object-cover img-hover"
            loading={eager ? 'eager' : 'lazy'}
            decoding="async"
            width="800"
            height="600"
            data-youtube-id={youtubeId}
            onerror={getYouTubeFallbackHandler('id')}
            onload="this.closest('.image-wrapper').querySelector('[data-placeholder]').classList.add('loaded')"
          />
        </picture>
      ) : (
        <!-- Local public image (string path) -->
        <Image
          src={displayImage}
          alt={heroImageAlt || title}
          width={800}
          height={600}
          class="w-full h-full object-cover img-hover"
          loading={eager ? 'eager' : 'lazy'}
          decoding="async"
          format="webp"
          quality={65}
          widths={[300, 400, 800]}
          sizes="(max-width: 640px) 100vw, (max-width: 1024px) 50vw, 400px"
          onload="this.closest('.image-wrapper').querySelector('[data-placeholder]').classList.add('loaded')"
        />
      )}
      <div class="absolute inset-0 bg-gradient-to-t from-ink/60 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
    </div>

    {showCategory && (
      <div class="mb-2">
        <span class="inline-block px-3 py-1 bg-ink/10 dark:bg-ink-dark/10 text-ink dark:text-ink-dark text-sm rounded-full">
          {category}
        </span>
      </div>
    )}

    <h2 class="text-2xl font-heading font-bold text-ink dark:text-ink-dark mb-2 group-hover:underline underline-offset-4 transition-all">
      {title}
    </h2>

    <p class="text-ink/70 dark:text-ink-dark/70 mb-4 line-clamp-3">
      {description}
    </p>

    <div class="flex items-center gap-2 text-sm text-ink/60 dark:text-ink-dark/60">
      <time datetime={pubDate.toISOString()}>
        {formattedDate}
      </time>
      {tags.length > 0 && (
        <>
          <span>â€¢</span>
          <span>#{tags[0]}</span>
        </>
      )}
    </div>
  </a>
</article>
