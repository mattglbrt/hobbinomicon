---
import { getCollection } from 'astro:content';
import { getHeroImageUrl } from '../utils/getHeroImage';
import { formatDateLong } from '../utils/formatDate';
import ListCard from './ListCard.astro';
import ViewAllLink from './ViewAllLink.astro';

interface Props {
  tag: string;
  excludeSelf?: string;
  excludeCategory?: string;
  excludeProjectPosts?: boolean;
  excludeHubs?: boolean;
  limit?: number;
}

const { tag, excludeSelf, excludeCategory, excludeProjectPosts = false, excludeHubs = true, limit } = Astro.props;

const allPosts = await getCollection('blog');
let taggedPosts = allPosts
  .filter(post => !post.data.draft)
  .filter(post => excludeSelf ? post.slug !== excludeSelf : true)
  .filter(post => excludeCategory ? post.data.category.toLowerCase() !== excludeCategory.toLowerCase() : true)
  .filter(post => excludeProjectPosts ? !post.data.project : true)
  .filter(post => excludeHubs ? post.data.resourceType !== 'hub' : true)
  .filter(post => post.data.tags?.some(t => t.toLowerCase().includes(tag.toLowerCase())))
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const totalCount = taggedPosts.length;
const hasMore = limit ? totalCount > limit : false;

if (limit) {
  taggedPosts = taggedPosts.slice(0, limit);
}
---

{taggedPosts.length > 0 ? (
  <div class="not-prose my-8">
    <div class="grid gap-4">
      {taggedPosts.map(post => (
        <ListCard
          href={`/blog/${post.slug}`}
          image={getHeroImageUrl(post.data.heroImage, post.data.youtubeId)}
          imageAlt={post.data.title}
          title={post.data.title}
          description={post.data.description}
          meta={formatDateLong(post.data.pubDate)}
          borderAccent
        />
      ))}
    </div>
    {hasMore && (
      <div class="mt-6 text-center">
        <ViewAllLink href={`/tags/${tag}`} variant="button">
          View all {totalCount} posts
        </ViewAllLink>
      </div>
    )}
  </div>
) : (
  <p class="text-ink/70 italic my-8">No posts found with this tag yet. Check back soon!</p>
)}
