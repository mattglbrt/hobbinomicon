---
import { getCollection } from 'astro:content';
import { getHeroImage } from '../utils/getHeroImage';

interface Props {
  tag: string;
  excludeSelf?: string;
  excludeCategory?: string;
  excludeProjectPosts?: boolean;
  limit?: number;
}

const { tag, excludeSelf, excludeCategory, excludeProjectPosts = false, limit } = Astro.props;

const allPosts = await getCollection('blog');
let taggedPosts = allPosts
  .filter(post => !post.data.draft)
  .filter(post => excludeSelf ? post.slug !== excludeSelf : true)
  .filter(post => excludeCategory ? post.data.category.toLowerCase() !== excludeCategory.toLowerCase() : true)
  .filter(post => excludeProjectPosts ? !post.data.project : true)
  .filter(post => post.data.tags?.some(t => t.toLowerCase().includes(tag.toLowerCase())))
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const totalCount = taggedPosts.length;
const hasMore = limit ? totalCount > limit : false;

if (limit) {
  taggedPosts = taggedPosts.slice(0, limit);
}
---

{taggedPosts.length > 0 ? (
  <div class="not-prose my-8">
    <div class="grid gap-4">
      {taggedPosts.map(post => {
        const heroImage = getHeroImage(post.data.heroImage, post.data.youtubeId);
        return (
          <a href={`/blog/${post.slug}`}
             class="flex gap-4 p-4 bg-ink/5 hover:bg-ink/10 border-l-4 border-ink/30 hover:border-ink transition-all rounded-r-lg group">
            <div class="flex-shrink-0 w-24 h-24 overflow-hidden rounded">
              <img
                src={heroImage}
                alt={post.data.title}
                class="w-full h-full object-cover"
                loading="lazy"
              />
            </div>
            <div class="flex-1 min-w-0">
              <h3 class="text-xl font-heading font-bold text-ink mb-2 group-hover:underline">
                {post.data.title}
              </h3>
              <p class="text-ink/80 text-sm mb-2 line-clamp-2">{post.data.description}</p>
              <p class="text-ink/60 text-xs">
                {new Date(post.data.pubDate).toLocaleDateString('en-US', {
                  year: 'numeric',
                  month: 'long',
                  day: 'numeric'
                })}
              </p>
            </div>
          </a>
        );
      })}
    </div>
    {hasMore && (
      <div class="mt-6 text-center">
        <a href={`/tags/${tag}`}
           class="inline-flex items-center gap-2 px-4 py-2 bg-ink/10 hover:bg-ink/20 text-ink rounded-lg transition-colors">
          View all {totalCount} posts
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </a>
      </div>
    )}
  </div>
) : (
  <p class="text-ink/60 italic my-8">No posts found with this tag yet. Check back soon!</p>
)}
