---
/**
 * Search Modal Component
 * Client-side search with keyboard navigation, filters, and accessibility
 */
import { getCollection } from 'astro:content';
import { getPublishedPosts, groupByTags } from '../utils/collections';
import { getTagDisplay } from '../utils/tags';

const allPosts = await getCollection('blog');
const publishedPosts = getPublishedPosts(allPosts);

// Get unique categories
const categories = [...new Set(publishedPosts.map(post => post.data.category))].sort();

// Get top tags by usage count
const tagsMap = groupByTags(publishedPosts);
const topTags = Array.from(tagsMap.entries())
  .sort((a, b) => b[1].length - a[1].length)
  .slice(0, 8)
  .map(([tag]) => ({ tag, display: getTagDisplay(tag) }));

// Build search index
const searchIndex = publishedPosts.map(post => ({
  slug: post.slug,
  title: post.data.title,
  description: post.data.description,
  category: post.data.category,
  tags: post.data.tags,
  // Create searchable text combining all fields
  searchText: [
    post.data.title,
    post.data.description,
    post.data.category,
    ...post.data.tags
  ].join(' ').toLowerCase()
}));
---

<style>
  .glass-modal {
    background: rgba(26, 22, 20, 0.85);
    backdrop-filter: blur(24px);
    -webkit-backdrop-filter: blur(24px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow:
      0 25px 50px -12px rgba(0, 0, 0, 0.5),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
  }

  .glass-input {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.2s ease;
  }

  .glass-input:focus {
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(255, 255, 255, 0.25);
    box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
  }

  .glass-input::placeholder {
    color: rgba(255, 255, 255, 0.4);
  }

  .result-item {
    transition: all 0.15s ease;
  }

  .result-item:hover,
  .result-item.selected {
    background: rgba(255, 255, 255, 0.08);
  }

  .glass-kbd {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .glass-tag {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.05);
  }

  .glass-footer {
    background: rgba(255, 255, 255, 0.03);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
  }

  .filter-chip {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.15s ease;
  }

  .filter-chip:hover {
    background: rgba(255, 255, 255, 0.1);
    border-color: rgba(255, 255, 255, 0.2);
  }

  .filter-chip.active {
    background: rgba(255, 255, 255, 0.15);
    border-color: rgba(255, 255, 255, 0.3);
  }

  /* Custom scrollbar for results */
  #search-results::-webkit-scrollbar {
    width: 6px;
  }

  #search-results::-webkit-scrollbar-track {
    background: transparent;
  }

  #search-results::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 3px;
  }

  #search-results::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.3);
  }
</style>

<!-- Search Modal -->
<div
  id="search-modal"
  class="fixed inset-0 z-[100] hidden"
  role="dialog"
  aria-modal="true"
  aria-labelledby="search-modal-title"
>
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" data-search-backdrop></div>

  <!-- Modal Content -->
  <div class="relative flex items-start justify-center pt-[10vh] px-4">
    <div class="w-full max-w-2xl glass-modal rounded-2xl overflow-hidden">
      <!-- Search Header -->
      <div class="p-4 pb-2">
        <label for="search-input" id="search-modal-title" class="sr-only">Search posts</label>
        <div class="relative">
          <svg
            class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-white/60"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <input
            type="text"
            id="search-input"
            class="w-full pl-12 pr-20 py-3.5 glass-input rounded-xl text-white text-base focus:outline-none"
            placeholder="Search posts..."
            autocomplete="off"
            autocapitalize="off"
            spellcheck="false"
          />
          <kbd class="absolute right-4 top-1/2 -translate-y-1/2 hidden sm:inline-block px-2 py-1 text-xs font-mono glass-kbd text-white/70 rounded-lg">ESC</kbd>
        </div>
      </div>

      <!-- Filters -->
      <div class="px-4 pb-3">
        <!-- Category Filters -->
        <div class="flex flex-wrap gap-2 mb-2">
          <button
            type="button"
            class="filter-chip px-3 py-1 rounded-full text-xs text-white/80 active"
            data-filter-category=""
          >
            All
          </button>
          {categories.map(category => (
            <button
              type="button"
              class="filter-chip px-3 py-1 rounded-full text-xs text-white/80"
              data-filter-category={category}
            >
              {category}
            </button>
          ))}
        </div>

        <!-- Tag Filters -->
        <div class="flex flex-wrap gap-2">
          {topTags.map(({ tag, display }) => (
            <button
              type="button"
              class="filter-chip px-2.5 py-0.5 rounded-full text-xs text-white/60"
              data-filter-tag={tag}
            >
              #{display}
            </button>
          ))}
        </div>
      </div>

      <!-- Search Results -->
      <div id="search-results" class="max-h-[50vh] overflow-y-auto">
        <!-- Empty state -->
        <div id="search-empty" class="p-8 text-center">
          <p class="text-lg text-white/60">Type to search posts</p>
          <p class="text-sm mt-2 text-white/60">Or click filters above to browse</p>
        </div>

        <!-- No results state -->
        <div id="search-no-results" class="hidden p-8 text-center">
          <p class="text-lg text-white/60">No results found</p>
          <p class="text-sm mt-2 text-white/60">Try different keywords or filters</p>
        </div>

        <!-- Results list -->
        <ul id="search-results-list" class="hidden" role="listbox">
        </ul>
      </div>

      <!-- Footer -->
      <div class="glass-footer p-3">
        <div class="flex items-center justify-between text-xs text-white/60">
          <div class="flex items-center gap-4">
            <span class="flex items-center gap-1.5">
              <kbd class="px-1.5 py-0.5 glass-kbd rounded text-white/70">↑</kbd>
              <kbd class="px-1.5 py-0.5 glass-kbd rounded text-white/70">↓</kbd>
              <span>navigate</span>
            </span>
            <span class="flex items-center gap-1.5">
              <kbd class="px-1.5 py-0.5 glass-kbd rounded text-white/70">↵</kbd>
              <span>select</span>
            </span>
          </div>
          <button
            type="button"
            class="text-white/60 hover:text-white/70 transition-colors"
            data-search-close
          >
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Pass search index to client -->
<script define:vars={{ searchIndex, categories, topTags }}>
  window.searchIndex = searchIndex;
  window.searchCategories = categories;
  window.searchTopTags = topTags;
</script>

<script is:inline>
(function() {
  // Only initialize once
  if (window.searchInitialized) return;
  window.searchInitialized = true;

  function initSearch() {
    const modal = document.getElementById('search-modal');
    const input = document.getElementById('search-input');
    const resultsContainer = document.getElementById('search-results');
    const resultsList = document.getElementById('search-results-list');
    const emptyState = document.getElementById('search-empty');
    const noResultsState = document.getElementById('search-no-results');
    const backdrop = document.querySelector('[data-search-backdrop]');
    const closeBtn = document.querySelector('[data-search-close]');
    const searchButtons = document.querySelectorAll('[data-search-trigger]');
    const categoryFilters = document.querySelectorAll('[data-filter-category]');
    const tagFilters = document.querySelectorAll('[data-filter-tag]');

    if (!modal || !input || !resultsList) return;

    let selectedIndex = -1;
    let results = [];
    let activeCategory = '';
    let activeTags = new Set();

    function openModal() {
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      setTimeout(function() { input.focus(); }, 50);
    }

    function closeModal() {
      modal.classList.add('hidden');
      document.body.style.overflow = '';
      input.value = '';
      selectedIndex = -1;
      results = [];
      activeCategory = '';
      activeTags.clear();
      resetFilters();
      showEmptyState();
    }

    function resetFilters() {
      categoryFilters.forEach(function(btn) {
        btn.classList.toggle('active', btn.dataset.filterCategory === '');
      });
      tagFilters.forEach(function(btn) {
        btn.classList.remove('active');
      });
    }

    function showEmptyState() {
      emptyState.classList.remove('hidden');
      noResultsState.classList.add('hidden');
      resultsList.classList.add('hidden');
    }

    function showNoResults() {
      emptyState.classList.add('hidden');
      noResultsState.classList.remove('hidden');
      resultsList.classList.add('hidden');
    }

    function showResults() {
      emptyState.classList.add('hidden');
      noResultsState.classList.add('hidden');
      resultsList.classList.remove('hidden');
    }

    function search(query) {
      var searchIndex = window.searchIndex || [];
      var terms = query.toLowerCase().split(/\s+/).filter(Boolean);
      var hasQuery = terms.length > 0;
      var hasFilters = activeCategory || activeTags.size > 0;

      if (!hasQuery && !hasFilters) {
        showEmptyState();
        return;
      }

      results = searchIndex.filter(function(item) {
        // Check category filter
        if (activeCategory && item.category !== activeCategory) {
          return false;
        }

        // Check tag filters (all selected tags must match)
        if (activeTags.size > 0) {
          var itemTags = item.tags.map(function(t) { return t.toLowerCase(); });
          var allTagsMatch = Array.from(activeTags).every(function(tag) {
            return itemTags.some(function(t) { return t === tag.toLowerCase(); });
          });
          if (!allTagsMatch) return false;
        }

        // Check search terms
        if (hasQuery) {
          return terms.every(function(term) {
            return item.searchText.includes(term);
          });
        }

        return true;
      }).slice(0, 15);

      if (results.length === 0) {
        showNoResults();
        return;
      }

      renderResults(results, terms);
      showResults();
      selectedIndex = -1;
    }

    function renderResults(results, terms) {
      resultsList.innerHTML = results.map(function(result, index) {
        var highlightedTitle = highlightTerms(result.title, terms);
        var highlightedDesc = highlightTerms(result.description, terms);
        var tagsHtml = result.tags.slice(0, 3).map(function(tag) {
          return '<span class="text-xs text-white/50">#' + escapeHtml(tag) + '</span>';
        }).join(' ');

        return '<li role="option" id="search-result-' + index + '">' +
          '<a href="/blog/' + result.slug + '" class="block px-4 py-3 result-item search-result-link" data-index="' + index + '">' +
            '<div class="font-medium text-white/90 mb-1">' + highlightedTitle + '</div>' +
            '<div class="text-sm text-white/70 line-clamp-2">' + highlightedDesc + '</div>' +
            '<div class="flex items-center gap-2 mt-2 flex-wrap">' +
              '<span class="text-xs px-2 py-0.5 glass-tag text-white/60 rounded-lg">' + escapeHtml(result.category) + '</span>' +
              tagsHtml +
            '</div>' +
          '</a>' +
        '</li>';
      }).join('');
    }

    function highlightTerms(text, terms) {
      if (!text || !terms.length) return escapeHtml(text || '');
      var result = escapeHtml(text);
      terms.forEach(function(term) {
        var regex = new RegExp('(' + escapeRegex(term) + ')', 'gi');
        result = result.replace(regex, '<mark class="bg-white/20 text-white rounded px-0.5">$1</mark>');
      });
      return result;
    }

    function escapeHtml(text) {
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function escapeRegex(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function updateSelection(newIndex) {
      var items = resultsList.querySelectorAll('li');
      if (items.length === 0) return;

      // Remove previous selection
      items.forEach(function(item) {
        item.querySelector('a').classList.remove('selected');
        item.removeAttribute('aria-selected');
      });

      // Update index
      if (newIndex < 0) newIndex = items.length - 1;
      if (newIndex >= items.length) newIndex = 0;
      selectedIndex = newIndex;

      // Apply new selection
      var selected = items[selectedIndex];
      if (selected) {
        selected.querySelector('a').classList.add('selected');
        selected.setAttribute('aria-selected', 'true');
        selected.scrollIntoView({ block: 'nearest' });
      }
    }

    // Category filter click handlers
    categoryFilters.forEach(function(btn) {
      btn.addEventListener('click', function() {
        activeCategory = btn.dataset.filterCategory;
        categoryFilters.forEach(function(b) {
          b.classList.toggle('active', b.dataset.filterCategory === activeCategory);
        });
        search(input.value);
      });
    });

    // Tag filter click handlers
    tagFilters.forEach(function(btn) {
      btn.addEventListener('click', function() {
        var tag = btn.dataset.filterTag;
        if (activeTags.has(tag)) {
          activeTags.delete(tag);
          btn.classList.remove('active');
        } else {
          activeTags.add(tag);
          btn.classList.add('active');
        }
        search(input.value);
      });
    });

    // Event listeners
    searchButtons.forEach(function(btn) {
      btn.addEventListener('click', openModal);
    });

    backdrop && backdrop.addEventListener('click', closeModal);
    closeBtn && closeBtn.addEventListener('click', closeModal);

    input.addEventListener('input', function(e) {
      search(e.target.value);
    });

    input.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeModal();
      } else if (e.key === 'ArrowDown') {
        e.preventDefault();
        updateSelection(selectedIndex + 1);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        updateSelection(selectedIndex - 1);
      } else if (e.key === 'Enter' && selectedIndex >= 0 && results[selectedIndex]) {
        e.preventDefault();
        window.location.href = '/blog/' + results[selectedIndex].slug;
      }
    });

    // Global keyboard shortcut (Cmd/Ctrl + K)
    document.addEventListener('keydown', function(e) {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        if (modal.classList.contains('hidden')) {
          openModal();
        } else {
          closeModal();
        }
      }
      if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
        closeModal();
      }
    });
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSearch);
  } else {
    initSearch();
  }

  // Re-initialize after View Transitions navigation
  document.addEventListener('astro:after-swap', function() {
    window.searchInitialized = false;
    initSearch();
    window.searchInitialized = true;
  });
})();
</script>
