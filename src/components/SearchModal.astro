---
/**
 * Search Modal Component
 * Client-side search with keyboard navigation and accessibility
 */
import { getCollection } from 'astro:content';
import { getPublishedPosts } from '../utils/collections';

const allPosts = await getCollection('blog');
const publishedPosts = getPublishedPosts(allPosts);

// Build search index
const searchIndex = publishedPosts.map(post => ({
  slug: post.slug,
  title: post.data.title,
  description: post.data.description,
  category: post.data.category,
  tags: post.data.tags,
  // Create searchable text combining all fields
  searchText: [
    post.data.title,
    post.data.description,
    post.data.category,
    ...post.data.tags
  ].join(' ').toLowerCase()
}));
---

<style>
  .glass-modal {
    background: rgba(26, 22, 20, 0.85);
    backdrop-filter: blur(24px);
    -webkit-backdrop-filter: blur(24px);
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow:
      0 25px 50px -12px rgba(0, 0, 0, 0.5),
      inset 0 1px 0 rgba(255, 255, 255, 0.1);
  }

  .glass-input {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    transition: all 0.2s ease;
  }

  .glass-input:focus {
    background: rgba(255, 255, 255, 0.08);
    border-color: rgba(255, 255, 255, 0.25);
    box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
  }

  .glass-input::placeholder {
    color: rgba(255, 255, 255, 0.4);
  }

  .result-item {
    transition: all 0.15s ease;
  }

  .result-item:hover,
  .result-item.selected {
    background: rgba(255, 255, 255, 0.08);
  }

  .glass-kbd {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .glass-tag {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.05);
  }

  .glass-footer {
    background: rgba(255, 255, 255, 0.03);
    border-top: 1px solid rgba(255, 255, 255, 0.1);
  }

  /* Custom scrollbar for results */
  #search-results::-webkit-scrollbar {
    width: 6px;
  }

  #search-results::-webkit-scrollbar-track {
    background: transparent;
  }

  #search-results::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 3px;
  }

  #search-results::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 255, 255, 0.3);
  }
</style>

<!-- Search Modal -->
<div
  id="search-modal"
  class="fixed inset-0 z-[100] hidden"
  role="dialog"
  aria-modal="true"
  aria-labelledby="search-modal-title"
>
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" data-search-backdrop></div>

  <!-- Modal Content -->
  <div class="relative flex items-start justify-center pt-[12vh] px-4">
    <div class="w-full max-w-2xl glass-modal rounded-2xl overflow-hidden">
      <!-- Search Header -->
      <div class="p-4">
        <label for="search-input" id="search-modal-title" class="sr-only">Search posts</label>
        <div class="relative">
          <svg
            class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-white/60"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <input
            type="text"
            id="search-input"
            class="w-full pl-12 pr-20 py-3.5 glass-input rounded-xl text-white text-base focus:outline-none"
            placeholder="Search posts..."
            autocomplete="off"
            autocapitalize="off"
            spellcheck="false"
          />
          <kbd class="absolute right-4 top-1/2 -translate-y-1/2 hidden sm:inline-block px-2 py-1 text-xs font-mono glass-kbd text-white/70 rounded-lg">ESC</kbd>
        </div>
      </div>

      <!-- Search Results -->
      <div id="search-results" class="max-h-[55vh] overflow-y-auto">
        <!-- Empty state -->
        <div id="search-empty" class="p-8 text-center">
          <p class="text-lg text-white/60">Type to search posts</p>
          <p class="text-sm mt-2 text-white/60">Search by title, description, category, or tags</p>
        </div>

        <!-- No results state -->
        <div id="search-no-results" class="hidden p-8 text-center">
          <p class="text-lg text-white/60">No results found</p>
          <p class="text-sm mt-2 text-white/60">Try different keywords</p>
        </div>

        <!-- Results list -->
        <ul id="search-results-list" class="hidden" role="listbox">
        </ul>
      </div>

      <!-- Footer -->
      <div class="glass-footer p-3">
        <div class="flex items-center justify-between text-xs text-white/60">
          <div class="flex items-center gap-4">
            <span class="flex items-center gap-1.5">
              <kbd class="px-1.5 py-0.5 glass-kbd rounded text-white/70">↑</kbd>
              <kbd class="px-1.5 py-0.5 glass-kbd rounded text-white/70">↓</kbd>
              <span>navigate</span>
            </span>
            <span class="flex items-center gap-1.5">
              <kbd class="px-1.5 py-0.5 glass-kbd rounded text-white/70">↵</kbd>
              <span>select</span>
            </span>
          </div>
          <button
            type="button"
            class="text-white/60 hover:text-white/70 transition-colors"
            data-search-close
          >
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Pass search index to client -->
<script define:vars={{ searchIndex }}>
  window.searchIndex = searchIndex;
</script>

<script is:inline>
(function() {
  // Only initialize once
  if (window.searchInitialized) return;
  window.searchInitialized = true;

  function initSearch() {
    const modal = document.getElementById('search-modal');
    const input = document.getElementById('search-input');
    const resultsContainer = document.getElementById('search-results');
    const resultsList = document.getElementById('search-results-list');
    const emptyState = document.getElementById('search-empty');
    const noResultsState = document.getElementById('search-no-results');
    const backdrop = document.querySelector('[data-search-backdrop]');
    const closeBtn = document.querySelector('[data-search-close]');
    const searchButtons = document.querySelectorAll('[data-search-trigger]');

    if (!modal || !input || !resultsList) return;

    let selectedIndex = -1;
    let results = [];

    function openModal() {
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      setTimeout(function() { input.focus(); }, 50);
    }

    function closeModal() {
      modal.classList.add('hidden');
      document.body.style.overflow = '';
      input.value = '';
      selectedIndex = -1;
      results = [];
      showEmptyState();
    }

    function showEmptyState() {
      emptyState.classList.remove('hidden');
      noResultsState.classList.add('hidden');
      resultsList.classList.add('hidden');
    }

    function showNoResults() {
      emptyState.classList.add('hidden');
      noResultsState.classList.remove('hidden');
      resultsList.classList.add('hidden');
    }

    function showResults() {
      emptyState.classList.add('hidden');
      noResultsState.classList.add('hidden');
      resultsList.classList.remove('hidden');
    }

    function search(query) {
      if (!query.trim()) {
        showEmptyState();
        return;
      }

      var searchIndex = window.searchIndex || [];
      var terms = query.toLowerCase().split(/\s+/).filter(Boolean);

      results = searchIndex.filter(function(item) {
        return terms.every(function(term) {
          return item.searchText.includes(term);
        });
      }).slice(0, 10);

      if (results.length === 0) {
        showNoResults();
        return;
      }

      renderResults(results, terms);
      showResults();
      selectedIndex = -1;
    }

    function renderResults(results, terms) {
      resultsList.innerHTML = results.map(function(result, index) {
        var highlightedTitle = highlightTerms(result.title, terms);
        var highlightedDesc = highlightTerms(result.description, terms);

        return '<li role="option" id="search-result-' + index + '">' +
          '<a href="/blog/' + result.slug + '" class="block px-4 py-3 result-item search-result-link" data-index="' + index + '">' +
            '<div class="font-medium text-white/90 mb-1">' + highlightedTitle + '</div>' +
            '<div class="text-sm text-white/70 line-clamp-2">' + highlightedDesc + '</div>' +
            '<div class="flex items-center gap-2 mt-2">' +
              '<span class="text-xs px-2 py-0.5 glass-tag text-white/60 rounded-lg">' + result.category + '</span>' +
              (result.tags.length > 0 ? '<span class="text-xs text-white/60">#' + result.tags[0] + '</span>' : '') +
            '</div>' +
          '</a>' +
        '</li>';
      }).join('');
    }

    function highlightTerms(text, terms) {
      if (!text) return '';
      var result = escapeHtml(text);
      terms.forEach(function(term) {
        var regex = new RegExp('(' + escapeRegex(term) + ')', 'gi');
        result = result.replace(regex, '<mark class="bg-white/20 text-white rounded px-0.5">$1</mark>');
      });
      return result;
    }

    function escapeHtml(text) {
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function escapeRegex(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function updateSelection(newIndex) {
      var items = resultsList.querySelectorAll('li');
      if (items.length === 0) return;

      // Remove previous selection
      items.forEach(function(item) {
        item.querySelector('a').classList.remove('selected');
        item.removeAttribute('aria-selected');
      });

      // Update index
      if (newIndex < 0) newIndex = items.length - 1;
      if (newIndex >= items.length) newIndex = 0;
      selectedIndex = newIndex;

      // Apply new selection
      var selected = items[selectedIndex];
      if (selected) {
        selected.querySelector('a').classList.add('selected');
        selected.setAttribute('aria-selected', 'true');
        selected.scrollIntoView({ block: 'nearest' });
      }
    }

    // Event listeners
    searchButtons.forEach(function(btn) {
      btn.addEventListener('click', openModal);
    });

    backdrop && backdrop.addEventListener('click', closeModal);
    closeBtn && closeBtn.addEventListener('click', closeModal);

    input.addEventListener('input', function(e) {
      search(e.target.value);
    });

    input.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeModal();
      } else if (e.key === 'ArrowDown') {
        e.preventDefault();
        updateSelection(selectedIndex + 1);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        updateSelection(selectedIndex - 1);
      } else if (e.key === 'Enter' && selectedIndex >= 0 && results[selectedIndex]) {
        e.preventDefault();
        window.location.href = '/blog/' + results[selectedIndex].slug;
      }
    });

    // Global keyboard shortcut (Cmd/Ctrl + K)
    document.addEventListener('keydown', function(e) {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        if (modal.classList.contains('hidden')) {
          openModal();
        } else {
          closeModal();
        }
      }
      if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
        closeModal();
      }
    });
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSearch);
  } else {
    initSearch();
  }

  // Re-initialize after View Transitions navigation
  document.addEventListener('astro:after-swap', function() {
    window.searchInitialized = false;
    initSearch();
    window.searchInitialized = true;
  });
})();
</script>
