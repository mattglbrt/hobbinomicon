---
/**
 * Search Modal Component
 * Client-side search with keyboard navigation and accessibility
 */
import { getCollection } from 'astro:content';
import { getPublishedPosts } from '../utils/collections';

const allPosts = await getCollection('blog');
const publishedPosts = getPublishedPosts(allPosts);

// Build search index
const searchIndex = publishedPosts.map(post => ({
  slug: post.slug,
  title: post.data.title,
  description: post.data.description,
  category: post.data.category,
  tags: post.data.tags,
  // Create searchable text combining all fields
  searchText: [
    post.data.title,
    post.data.description,
    post.data.category,
    ...post.data.tags
  ].join(' ').toLowerCase()
}));
---

<!-- Search Modal -->
<div
  id="search-modal"
  class="fixed inset-0 z-[100] hidden"
  role="dialog"
  aria-modal="true"
  aria-labelledby="search-modal-title"
>
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-ink/80 backdrop-blur-sm" data-search-backdrop></div>

  <!-- Modal Content -->
  <div class="relative flex items-start justify-center pt-[15vh] px-4">
    <div class="w-full max-w-2xl bg-parchment dark:bg-parchment-dark border-2 border-ink dark:border-ink-dark rounded-lg shadow-2xl overflow-hidden">
      <!-- Search Header -->
      <div class="p-4 border-b border-ink/20 dark:border-ink-dark/20">
        <label for="search-input" id="search-modal-title" class="sr-only">Search posts</label>
        <div class="relative">
          <svg
            class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-ink/50 dark:text-ink-dark/50"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <input
            type="text"
            id="search-input"
            class="w-full pl-12 pr-4 py-3 bg-white dark:bg-ink border border-ink/20 dark:border-ink-dark/20 rounded-lg text-ink dark:text-ink-dark placeholder-ink/50 dark:placeholder-ink-dark/50 focus:outline-none focus:ring-2 focus:ring-ink dark:focus:ring-ink-dark"
            placeholder="Search posts..."
            autocomplete="off"
            autocapitalize="off"
            spellcheck="false"
          />
          <kbd class="absolute right-4 top-1/2 -translate-y-1/2 hidden sm:inline-block px-2 py-1 text-xs font-mono bg-ink/10 dark:bg-ink-dark/10 text-ink/60 dark:text-ink-dark/60 rounded">ESC</kbd>
        </div>
      </div>

      <!-- Search Results -->
      <div id="search-results" class="max-h-[60vh] overflow-y-auto">
        <!-- Empty state -->
        <div id="search-empty" class="p-8 text-center text-ink/60 dark:text-ink-dark/60">
          <p class="text-lg">Type to search posts</p>
          <p class="text-sm mt-2">Search by title, description, category, or tags</p>
        </div>

        <!-- No results state -->
        <div id="search-no-results" class="hidden p-8 text-center text-ink/60 dark:text-ink-dark/60">
          <p class="text-lg">No results found</p>
          <p class="text-sm mt-2">Try different keywords</p>
        </div>

        <!-- Results list -->
        <ul id="search-results-list" class="hidden divide-y divide-ink/10 dark:divide-ink-dark/10" role="listbox">
        </ul>
      </div>

      <!-- Footer -->
      <div class="p-3 border-t border-ink/20 dark:border-ink-dark/20 bg-ink/5 dark:bg-ink-dark/5">
        <div class="flex items-center justify-between text-xs text-ink/50 dark:text-ink-dark/50">
          <div class="flex items-center gap-4">
            <span class="flex items-center gap-1">
              <kbd class="px-1.5 py-0.5 bg-ink/10 dark:bg-ink-dark/10 rounded">↑</kbd>
              <kbd class="px-1.5 py-0.5 bg-ink/10 dark:bg-ink-dark/10 rounded">↓</kbd>
              <span>navigate</span>
            </span>
            <span class="flex items-center gap-1">
              <kbd class="px-1.5 py-0.5 bg-ink/10 dark:bg-ink-dark/10 rounded">↵</kbd>
              <span>select</span>
            </span>
          </div>
          <button
            type="button"
            class="text-ink/50 dark:text-ink-dark/50 hover:text-ink dark:hover:text-ink-dark transition-colors"
            data-search-close
          >
            Close
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Pass search index to client -->
<script define:vars={{ searchIndex }}>
  window.searchIndex = searchIndex;
</script>

<script is:inline>
(function() {
  // Only initialize once
  if (window.searchInitialized) return;
  window.searchInitialized = true;

  function initSearch() {
    const modal = document.getElementById('search-modal');
    const input = document.getElementById('search-input');
    const resultsContainer = document.getElementById('search-results');
    const resultsList = document.getElementById('search-results-list');
    const emptyState = document.getElementById('search-empty');
    const noResultsState = document.getElementById('search-no-results');
    const backdrop = document.querySelector('[data-search-backdrop]');
    const closeBtn = document.querySelector('[data-search-close]');
    const searchButtons = document.querySelectorAll('[data-search-trigger]');

    if (!modal || !input || !resultsList) return;

    let selectedIndex = -1;
    let results = [];

    function openModal() {
      modal.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
      setTimeout(function() { input.focus(); }, 50);
    }

    function closeModal() {
      modal.classList.add('hidden');
      document.body.style.overflow = '';
      input.value = '';
      selectedIndex = -1;
      results = [];
      showEmptyState();
    }

    function showEmptyState() {
      emptyState.classList.remove('hidden');
      noResultsState.classList.add('hidden');
      resultsList.classList.add('hidden');
    }

    function showNoResults() {
      emptyState.classList.add('hidden');
      noResultsState.classList.remove('hidden');
      resultsList.classList.add('hidden');
    }

    function showResults() {
      emptyState.classList.add('hidden');
      noResultsState.classList.add('hidden');
      resultsList.classList.remove('hidden');
    }

    function search(query) {
      if (!query.trim()) {
        showEmptyState();
        return;
      }

      var searchIndex = window.searchIndex || [];
      var terms = query.toLowerCase().split(/\s+/).filter(Boolean);

      results = searchIndex.filter(function(item) {
        return terms.every(function(term) {
          return item.searchText.includes(term);
        });
      }).slice(0, 10);

      if (results.length === 0) {
        showNoResults();
        return;
      }

      renderResults(results, terms);
      showResults();
      selectedIndex = -1;
    }

    function renderResults(results, terms) {
      resultsList.innerHTML = results.map(function(result, index) {
        var highlightedTitle = highlightTerms(result.title, terms);
        var highlightedDesc = highlightTerms(result.description, terms);

        return '<li role="option" id="search-result-' + index + '">' +
          '<a href="/blog/' + result.slug + '" class="block p-4 hover:bg-ink/5 dark:hover:bg-ink-dark/5 transition-colors search-result-link" data-index="' + index + '">' +
            '<div class="font-heading font-bold text-ink dark:text-ink-dark mb-1">' + highlightedTitle + '</div>' +
            '<div class="text-sm text-ink/70 dark:text-ink-dark/70 line-clamp-2">' + highlightedDesc + '</div>' +
            '<div class="flex items-center gap-2 mt-2">' +
              '<span class="text-xs px-2 py-0.5 bg-ink/10 dark:bg-ink-dark/10 text-ink/60 dark:text-ink-dark/60 rounded">' + result.category + '</span>' +
              (result.tags.length > 0 ? '<span class="text-xs text-ink/50 dark:text-ink-dark/50">#' + result.tags[0] + '</span>' : '') +
            '</div>' +
          '</a>' +
        '</li>';
      }).join('');
    }

    function highlightTerms(text, terms) {
      if (!text) return '';
      var result = escapeHtml(text);
      terms.forEach(function(term) {
        var regex = new RegExp('(' + escapeRegex(term) + ')', 'gi');
        result = result.replace(regex, '<mark class="bg-yellow-200 dark:bg-yellow-800 text-ink dark:text-ink-dark">$1</mark>');
      });
      return result;
    }

    function escapeHtml(text) {
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function escapeRegex(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function updateSelection(newIndex) {
      var items = resultsList.querySelectorAll('li');
      if (items.length === 0) return;

      // Remove previous selection
      items.forEach(function(item) {
        item.classList.remove('bg-ink/5', 'dark:bg-ink-dark/5');
        item.removeAttribute('aria-selected');
      });

      // Update index
      if (newIndex < 0) newIndex = items.length - 1;
      if (newIndex >= items.length) newIndex = 0;
      selectedIndex = newIndex;

      // Apply new selection
      var selected = items[selectedIndex];
      if (selected) {
        selected.classList.add('bg-ink/5', 'dark:bg-ink-dark/5');
        selected.setAttribute('aria-selected', 'true');
        selected.scrollIntoView({ block: 'nearest' });
      }
    }

    // Event listeners
    searchButtons.forEach(function(btn) {
      btn.addEventListener('click', openModal);
    });

    backdrop && backdrop.addEventListener('click', closeModal);
    closeBtn && closeBtn.addEventListener('click', closeModal);

    input.addEventListener('input', function(e) {
      search(e.target.value);
    });

    input.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        closeModal();
      } else if (e.key === 'ArrowDown') {
        e.preventDefault();
        updateSelection(selectedIndex + 1);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        updateSelection(selectedIndex - 1);
      } else if (e.key === 'Enter' && selectedIndex >= 0 && results[selectedIndex]) {
        e.preventDefault();
        window.location.href = '/blog/' + results[selectedIndex].slug;
      }
    });

    // Global keyboard shortcut (Cmd/Ctrl + K)
    document.addEventListener('keydown', function(e) {
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        if (modal.classList.contains('hidden')) {
          openModal();
        } else {
          closeModal();
        }
      }
      if (e.key === 'Escape' && !modal.classList.contains('hidden')) {
        closeModal();
      }
    });
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSearch);
  } else {
    initSearch();
  }

  // Re-initialize after View Transitions navigation
  document.addEventListener('astro:after-swap', function() {
    window.searchInitialized = false;
    initSearch();
    window.searchInitialized = true;
  });
})();
</script>
