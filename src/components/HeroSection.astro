---
import { Image } from 'astro:assets';
import { formatDateLong } from '../utils/formatDate';
import { getYouTubeFallbackHandler } from '../utils/youtubeImageFallback';

interface Props {
  slug: string;
  title: string;
  description: string;
  heroImage: string;
  heroImageAlt?: string;
  category: string;
  pubDate: Date;
  tags?: string[];
  badge?: string;
  size?: 'large' | 'medium';
}

const {
  slug,
  title,
  description,
  heroImage,
  heroImageAlt,
  category,
  pubDate,
  tags = [],
  badge = '',
  size = 'large'
} = Astro.props;

const formattedDate = formatDateLong(pubDate);

const titleSize = size === 'large'
  ? 'text-4xl md:text-6xl lg:text-7xl'
  : 'text-4xl md:text-5xl lg:text-6xl';

const descriptionVisible = size === 'large';
const isRemoteImage = heroImage.startsWith('http');
---

<style>
  .hero-image-wrapper img {
    animation: fadeIn 0.5s ease-in;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  .hero-loading {
    backdrop-filter: blur(20px);
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
  }
</style>

<section class="relative h-screen overflow-hidden group pt-20 md:pt-24 hero-image-wrapper">
  <div class="absolute inset-0 hero-loading"></div>
  {isRemoteImage ? (
    <picture>
      <source
        srcset={heroImage}
        type="image/webp"
        media="(min-width: 1024px)"
      />
      <img
        src={heroImage}
        alt={heroImageAlt || title}
        class="absolute inset-0 w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
        loading={badge === 'Latest Post' ? 'eager' : 'lazy'}
        decoding="async"
        width="1920"
        height="1080"
        data-youtube-url={heroImage.includes('youtube.com') ? heroImage : undefined}
        onerror={getYouTubeFallbackHandler('url')}
      />
    </picture>
  ) : (
    <Image
      src={heroImage}
      alt={heroImageAlt || title}
      width={1920}
      height={1080}
      class="absolute inset-0 w-full h-full object-cover transition-transform duration-700 group-hover:scale-105"
      loading={badge === 'Latest Post' ? 'eager' : 'lazy'}
      decoding="async"
      format="webp"
      quality={85}
      widths={[768, 1024, 1920, 2560]}
      sizes="100vw"
    />
  )}
  <div class="absolute inset-0 bg-gradient-to-t from-ink via-ink/50 to-transparent"></div>

  <a
    href={`/blog/${slug}`}
    class="absolute bottom-0 left-0 p-8 md:p-12 lg:p-16 max-w-3xl group-hover:translate-x-2 transition-transform duration-300"
  >
    {badge && (
      <div class="mb-4">
        <span class="inline-block px-4 py-2 bg-white/20 backdrop-blur-md text-white text-sm font-medium rounded-full">
          {badge}
        </span>
      </div>
    )}

    <h2 class={`${titleSize} font-heading font-bold text-white mb-4 drop-shadow-2xl leading-tight`}>
      {title}
    </h2>

    {descriptionVisible && (
      <p class="text-lg md:text-xl text-white/90 mb-6 drop-shadow-lg font-serif">
        {description}
      </p>
    )}

    <div class="flex flex-wrap gap-4 items-center text-white/90 text-sm md:text-base">
      <time datetime={pubDate.toISOString()}>
        {formattedDate}
      </time>
      <span>•</span>
      <span class="px-3 py-1 bg-white/20 backdrop-blur-sm rounded">
        {category}
      </span>
      {tags.length > 0 && (
        <>
          <span>•</span>
          <div class="flex gap-2">
            {tags.slice(0, 3).map((tag) => (
              <span class="text-white/80">#{tag}</span>
            ))}
          </div>
        </>
      )}
    </div>
  </a>

  {badge === 'Latest Post' && (
    <div class="absolute bottom-8 right-8 text-white animate-bounce">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
      </svg>
    </div>
  )}
</section>
