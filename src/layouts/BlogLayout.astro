---
import { Image } from 'astro:assets';
import BaseLayout from './BaseLayout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import RelatedPosts from '../components/RelatedPosts.astro';
import ProjectNavigation from '../components/ProjectNavigation.astro';
import BackToTop from '../components/BackToTop.astro';
import StructuredData from '../components/StructuredData.astro';
import Comments from '../components/Comments.astro';
import ProseContent from '../components/ProseContent.astro';
import { getHeroImage, getHeroImageUrl, isImageMetadata } from '../utils/getHeroImage';
import { formatReadingTime } from '../utils/readingTime';
import { formatDateLong } from '../utils/formatDate';
import { getYouTubeFallbackHandler } from '../utils/youtubeImageFallback';
import type { CollectionEntry } from 'astro:content';

interface ProjectNav {
  previousPost: CollectionEntry<'blog'> | null;
  nextPost: CollectionEntry<'blog'> | null;
  projectName: string;
  projectSlug: string;
}

interface Props {
  title: string;
  description: string;
  pubDate: Date;
  updatedDate?: Date;
  heroImage?: string;
  heroImageAlt?: string;
  category: string;
  tags: string[];
  youtubeId?: string;
  readingTime?: number;
  relatedPosts?: CollectionEntry<'blog'>[];
  projectNavigation?: ProjectNav | null;
  campaign?: string;
  slug: string;
}

const { title, description, pubDate, updatedDate, heroImage, heroImageAlt, category, tags, youtubeId, readingTime, relatedPosts = [], projectNavigation = null, campaign, slug } = Astro.props;

const displayImage = getHeroImage(heroImage, youtubeId);
const displayImageUrl = getHeroImageUrl(heroImage, youtubeId);
const isOptimizedImage = isImageMetadata(displayImage);
const isRemoteImage = !isOptimizedImage && typeof displayImage === 'string' && displayImage.startsWith('http');

const formattedDate = formatDateLong(pubDate);
const formattedUpdatedDate = updatedDate ? formatDateLong(updatedDate) : null;
const isCharacterPost = category === 'Dramatis Personae';

// Build full image URL for structured data
const imageUrl = displayImageUrl.startsWith('http')
  ? displayImageUrl
  : new URL(displayImageUrl, Astro.site || Astro.url).toString();

// Build canonical URL for this post
const canonicalUrl = new URL(Astro.url.pathname, Astro.site || Astro.url).toString();

// Estimate word count from reading time (assuming ~200 words per minute)
const estimatedWordCount = readingTime ? readingTime * 200 : undefined;
---

<BaseLayout title={title} description={description}>
  <!-- BlogPosting Structured Data -->
  <StructuredData
    type="blogPosting"
    data={{
      title,
      description,
      image: imageUrl,
      datePublished: pubDate,
      dateModified: updatedDate,
      authorName: 'Hobbinomicon',
      authorUrl: 'https://hobbinomicon.com/about',
      keywords: tags,
      category,
      wordCount: estimatedWordCount,
      url: canonicalUrl,
    }}
  />
  <StructuredData
    type="breadcrumb"
    data={{
      breadcrumbs: [
        { name: 'Home', url: 'https://hobbinomicon.com/' },
        { name: 'Blog', url: 'https://hobbinomicon.com/blog' },
        { name: category, url: `https://hobbinomicon.com/categories/${category.toLowerCase().replace(/\s+/g, '-')}` },
        { name: title, url: canonicalUrl },
      ],
    }}
  />
  <Header />
  <main id="main-content" class="min-h-screen bg-parchment dark:bg-parchment-dark">
    {isCharacterPost ? (
      <!-- Character Post Layout -->
      <div class="pt-24 md:pt-32">
        <article class="max-w-6xl mx-auto px-6 py-12 md:py-16">
          <!-- Title -->
          <h1 class="text-4xl md:text-6xl lg:text-7xl font-heading font-bold text-ink dark:text-ink-dark mb-4">
            {title}
          </h1>
          <div class="flex flex-wrap gap-4 text-ink/70 dark:text-ink-dark/70 text-sm md:text-base mb-4">
            <time datetime={pubDate.toISOString()}>{formattedDate}</time>
            {readingTime && (
              <>
                <span>•</span>
                <span>{formatReadingTime(readingTime)}</span>
              </>
            )}
            <span>•</span>
            <span class="px-3 py-1 bg-ink/10 dark:bg-ink-dark/10 rounded">{category}</span>
          </div>

          <!-- Campaign Link -->
          {campaign && (
            <div class="mb-8">
              <a
                href={`/tags/${campaign}`}
                class="inline-flex items-center gap-2 px-4 py-2 bg-ink/10 dark:bg-ink-dark/10 hover:bg-ink/20 dark:hover:bg-ink-dark/20 text-ink dark:text-ink-dark rounded-lg transition-colors"
              >
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                </svg>
                <span class="font-medium">Campaign: {campaign}</span>
              </a>
            </div>
          )}

          <!-- Tags -->
          {tags.length > 0 && (
            <div class="flex flex-wrap gap-2 mb-8">
              {tags.map((tag) => (
                <a
                  href={`/tags/${tag}`}
                  class="text-sm px-3 py-1 bg-ink/5 dark:bg-ink-dark/5 hover:bg-ink/20 dark:hover:bg-ink-dark/20 text-ink dark:text-ink-dark rounded-full transition-colors"
                >
                  #{tag}
                </a>
              ))}
            </div>
          )}

          <!-- Two Column Layout: Image + Content -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">
            <!-- Character Image -->
            <div class="relative">
              <div class="sticky top-24">
                {isRemoteImage ? (
                  <img
                    src={displayImage}
                    alt={heroImageAlt || title}
                    class="w-full rounded-lg shadow-2xl object-cover object-top"
                    width="800"
                    height="1200"
                    data-youtube-id={youtubeId}
                    onerror={getYouTubeFallbackHandler('id')}
                  />
                ) : (
                  <Image
                    src={displayImage}
                    alt={heroImageAlt || title}
                    width={800}
                    height={1200}
                    class="w-full rounded-lg shadow-2xl object-cover object-top"
                  />
                )}
              </div>
            </div>

            <!-- Content -->
            <div>
              <!-- Description -->
              <p class="text-xl md:text-2xl text-ink/80 dark:text-ink-dark/80 font-serif italic mb-8 leading-relaxed border-l-4 border-ink/30 dark:border-ink-dark/30 pl-6">
                {description}
              </p>

              <!-- Blog Content -->
              <ProseContent variant="compact">
                <slot />
              </ProseContent>

              <!-- Updated Date -->
              {formattedUpdatedDate && (
                <p class="text-sm text-ink/60 italic mt-12 pt-8 border-t border-ink/10">
                  Last updated: {formattedUpdatedDate}
                </p>
              )}

              <!-- Project Navigation (Previous/Next in series) -->
              {projectNavigation && (
                <ProjectNavigation
                  previousPost={projectNavigation.previousPost}
                  nextPost={projectNavigation.nextPost}
                  projectName={projectNavigation.projectName}
                  projectSlug={projectNavigation.projectSlug}
                />
              )}

              <!-- Related Posts -->
              {relatedPosts.length > 0 && (
                <RelatedPosts posts={relatedPosts} />
              )}

              <!-- Comments -->
              <Comments postSlug={slug} />
            </div>
          </div>
        </article>
      </div>
    ) : (
      <!-- Standard Blog Post Layout -->
      <>
        <!-- Hero Image -->
        <div class="relative h-[60vh] md:h-[70vh] overflow-hidden">
          {isOptimizedImage ? (
            <!-- Optimized image from hero-cache (ImageMetadata) -->
            <Image
              src={displayImage}
              alt={heroImageAlt || title}
              width={1920}
              height={1080}
              class="w-full h-full object-cover object-top"
              loading="eager"
              decoding="sync"
              format="webp"
              quality={65}
              widths={[640, 1024, 1920]}
              sizes="100vw"
            />
          ) : isRemoteImage ? (
            <!-- Remote image (YouTube fallback) -->
            <img
              src={displayImage}
              alt={heroImageAlt || title}
              class="w-full h-full object-cover object-top"
              width="1920"
              height="1080"
              loading="eager"
              fetchpriority="high"
              decoding="sync"
              data-youtube-id={youtubeId}
              onerror={getYouTubeFallbackHandler('id')}
            />
          ) : (
            <!-- Local public image (string path) -->
            <Image
              src={displayImage}
              alt={heroImageAlt || title}
              width={1920}
              height={1080}
              class="w-full h-full object-cover object-top"
              loading="eager"
              decoding="sync"
              format="webp"
              quality={65}
              widths={[640, 1024, 1920]}
              sizes="100vw"
            />
          )}
          <div class="absolute inset-0 bg-gradient-to-t from-ink/60 to-transparent"></div>

          <!-- Title Overlay -->
          <div class="absolute bottom-0 left-0 right-0 px-6 pb-8 md:pb-12 lg:pb-16">
            <div class="max-w-7xl mx-auto">
              <div class="max-w-4xl">
                <h1 class="text-4xl md:text-6xl lg:text-7xl font-heading font-bold text-white mb-4 drop-shadow-2xl">
                  {title}
                </h1>
                <div class="flex flex-wrap gap-4 text-white/90 text-sm md:text-base">
                  <time datetime={pubDate.toISOString()}>{formattedDate}</time>
                  {readingTime && (
                    <>
                      <span>•</span>
                      <span>{formatReadingTime(readingTime)}</span>
                    </>
                  )}
                  <span>•</span>
                  <span class="px-3 py-1 bg-white/20 backdrop-blur-sm rounded">{category}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Content -->
        <article class="max-w-3xl mx-auto px-6 py-12 md:py-16">
          <!-- Description -->
          <p class="text-xl md:text-2xl text-ink/80 dark:text-ink-dark/80 font-serif italic mb-8 leading-relaxed border-l-4 border-ink/30 dark:border-ink-dark/30 pl-6">
            {description}
          </p>

          <!-- Tags -->
          {tags.length > 0 && (
            <div class="flex flex-wrap gap-2 mb-8">
              {tags.map((tag) => (
                <a
                  href={`/tags/${tag}`}
                  class="text-sm px-3 py-1 bg-ink/5 dark:bg-ink-dark/5 hover:bg-ink/20 dark:hover:bg-ink-dark/20 text-ink dark:text-ink-dark rounded-full transition-colors"
                >
                  #{tag}
                </a>
              ))}
            </div>
          )}

          <!-- Blog Content -->
          <ProseContent>
            <slot />
          </ProseContent>

          <!-- Updated Date -->
          {formattedUpdatedDate && (
            <p class="text-sm text-ink/60 italic mt-12 pt-8 border-t border-ink/10">
              Last updated: {formattedUpdatedDate}
            </p>
          )}

          <!-- Project Navigation (Previous/Next in series) -->
          {projectNavigation && (
            <ProjectNavigation
              previousPost={projectNavigation.previousPost}
              nextPost={projectNavigation.nextPost}
              projectName={projectNavigation.projectName}
              projectSlug={projectNavigation.projectSlug}
            />
          )}

          <!-- Related Posts -->
          {relatedPosts.length > 0 && (
            <RelatedPosts posts={relatedPosts} />
          )}

          <!-- Comments -->
          <Comments postSlug={slug} />
        </article>
      </>
    )}

    <!-- Back to Top Button -->
    <BackToTop />
  </main>
  <Footer />
</BaseLayout>
