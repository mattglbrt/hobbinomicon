---
import { ViewTransitions } from 'astro:transitions';
import RandomToad from '../components/RandomToad.astro';
import SkipLink from '../components/SkipLink.astro';
import StructuredData from '../components/StructuredData.astro';
import SearchModal from '../components/SearchModal.astro';
import '../styles/fonts.css';

interface Props {
  title: string;
  description?: string;
  image?: string;
}

const {
  title,
  description = 'The Hobbinomicon - Hobbying from the deep end of the dungeon.',
  image = '/og-image.jpg'
} = Astro.props;

const canonicalURL = Astro.site
  ? new URL(Astro.url.pathname, Astro.site)
  : Astro.url;
---

<!doctype html>
<html lang="en">
  <head>
    <!-- Dark mode initialization (must be first to prevent flash) -->
    <script is:inline>
      (function() {
        function applyDarkMode() {
          const stored = localStorage.getItem('darkMode');

          if (stored === 'dark') {
            document.documentElement.classList.add('dark');
          } else if (stored === 'light') {
            document.documentElement.classList.remove('dark');
          } else {
            // No preference stored - use system preference
            if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
              document.documentElement.classList.add('dark');
            } else {
              document.documentElement.classList.remove('dark');
            }
          }
        }

        // Apply immediately on page load
        applyDarkMode();

        // Re-apply after View Transitions navigation
        document.addEventListener('astro:after-swap', applyDarkMode);
      })();
    </script>
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width" />

    <!-- Slot for critical page-specific preloads (LCP images) - must be early in head -->
    <slot name="head" />

    <!-- Preload critical heading font to prevent CLS from font swap -->
    <link rel="preload" href="/fonts/besley-regular.woff2" as="font" type="font/woff2" crossorigin />

    <!-- Critical font-face declarations (must be inline for LCP optimization) -->
    <style is:inline>
      @font-face {
        font-family: 'IM Fell DW Pica';
        font-style: normal;
        font-weight: 400;
        font-display: optional;
        src: url('/fonts/imfell-regular.woff2') format('woff2');
      }
    </style>

    <!-- Preconnect to YouTube for hero images -->
    <link rel="preconnect" href="https://img.youtube.com" crossorigin />
    <link rel="dns-prefetch" href="https://img.youtube.com" />

    <!-- Favicons -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />

    <link rel="canonical" href={canonicalURL} />
    <meta name="generator" content={Astro.generator} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={Astro.url} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={new URL(image, Astro.url)} />
    <meta property="og:site_name" content="The Hobbinomicon" />
    <meta property="og:locale" content="en_US" />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={Astro.url} />
    <meta property="twitter:title" content={title} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={new URL(image, Astro.url)} />
    <meta property="twitter:creator" content="@hobbinomicon" />

    <title>{title}</title>
    <ViewTransitions />

    <!-- Google Analytics (deferred to avoid render blocking) -->
    <script is:inline>
      (function() {
        function loadGA() {
          var script = document.createElement('script');
          script.src = 'https://www.googletagmanager.com/gtag/js?id=G-990EP8N5XW';
          script.async = true;
          document.head.appendChild(script);
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          window.gtag = gtag;
          gtag('js', new Date());
          gtag('config', 'G-990EP8N5XW');
        }
        if ('requestIdleCallback' in window) {
          requestIdleCallback(loadGA);
        } else {
          setTimeout(loadGA, 2000);
        }
      })();
    </script>

    <!-- Print Stylesheet -->
    <style is:global>
      @media print {
        /* Reset colors for print */
        html, body {
          background: white !important;
          color: black !important;
          font-size: 12pt !important;
          line-height: 1.5 !important;
        }

        /* Override dark mode for print */
        .dark {
          background: white !important;
          color: black !important;
        }

        /* Hide non-essential elements */
        header,
        footer,
        nav,
        .dark-mode-toggle,
        .back-to-top,
        .skip-link,
        .random-toad,
        [data-toad],
        button,
        .pagination,
        .category-shortcuts,
        video,
        iframe,
        .hero-section,
        .character-card,
        .youtube-cta,
        #search-modal {
          display: none !important;
        }

        /* Reset all text colors */
        *,
        *::before,
        *::after {
          color: black !important;
          background: transparent !important;
          box-shadow: none !important;
          text-shadow: none !important;
        }

        /* Ensure links are visible */
        a {
          text-decoration: underline !important;
        }

        /* Show URL after links in articles */
        article a[href^="http"]::after {
          content: " (" attr(href) ")";
          font-size: 0.8em;
          font-style: italic;
        }

        /* Don't show URL for internal links */
        article a[href^="/"]::after,
        article a[href^="#"]::after {
          content: none;
        }

        /* Images */
        img {
          max-width: 100% !important;
          page-break-inside: avoid;
        }

        /* Typography */
        h1, h2, h3, h4, h5, h6 {
          page-break-after: avoid;
          page-break-inside: avoid;
        }

        p, blockquote, ul, ol {
          orphans: 3;
          widows: 3;
        }

        /* Main content area */
        main {
          padding: 0 !important;
          margin: 0 !important;
          max-width: 100% !important;
        }

        article {
          padding: 1cm !important;
          max-width: 100% !important;
        }

        /* Prose content */
        .prose {
          max-width: 100% !important;
          font-size: 12pt !important;
        }

        .prose h1 { font-size: 24pt !important; }
        .prose h2 { font-size: 18pt !important; }
        .prose h3 { font-size: 14pt !important; }
        .prose p { font-size: 12pt !important; }

        /* Code blocks */
        pre, code {
          border: 1px solid #ccc !important;
          background: #f5f5f5 !important;
          page-break-inside: avoid;
        }

        /* Tags - show inline */
        .tags a {
          border: 1px solid #ccc !important;
          padding: 2px 6px !important;
        }

        /* Page margins */
        @page {
          margin: 2cm;
        }

        @page :first {
          margin-top: 3cm;
        }
      }
    </style>

    <!-- Structured Data -->
    <StructuredData
      type="website"
      data={{
        siteName: 'The Hobbinomicon',
        siteUrl: 'https://hobbinomicon.com',
        siteDescription: description,
      }}
    />
    <StructuredData
      type="organization"
      data={{
        orgName: 'The Hobbinomicon',
        orgUrl: 'https://hobbinomicon.com',
        orgLogo: 'https://hobbinomicon.com/og-image.jpg',
        socialLinks: [
          'https://www.youtube.com/@Hobbinomicon',
          'https://twitter.com/hobbinomicon',
        ],
      }}
    />
  </head>
  <body class="min-h-screen font-serif bg-parchment dark:bg-parchment-dark text-ink dark:text-ink-dark transition-colors duration-300">
    <SkipLink />
    <slot />
    <RandomToad />
    <SearchModal />
  </body>
</html>
